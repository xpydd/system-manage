<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>字典管理 - 企业后台管理系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="data.js"></script>
  <script src="layout.js"></script>
</head>
<body class="bg-gray-100 font-sans antialiased h-screen flex overflow-hidden" id="app">
  <!-- Layout will be injected here -->
  <div class="flex-1 flex flex-col min-w-0 bg-gray-50" id="main-content">
    <main class="flex-1 overflow-auto p-6">
      <div class="mb-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900">字典管理</h1>
        <button onclick="openAddDictionaryModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm flex items-center">
          <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
          新增字典
        </button>
      </div>

      <!-- 字典列表 -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">字典编码</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">字典名称</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">字典类型</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">绑定资源</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="dictionary-list">
              <!-- JS 渲染 -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Add/Edit Dictionary Modal -->
  <div id="dictionary-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeDictionaryModal()"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <h3 class="text-lg leading-6 font-medium text-gray-900" id="dictionary-modal-title">新增字典</h3>
          <input type="hidden" id="editing-dictionary-id">
          <div class="mt-4 space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">字典编码 <span class="text-red-500">*</span></label>
              <input type="text" id="dict-code" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="请输入字典编码（如：base_version）">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">字典名称 <span class="text-red-500">*</span></label>
              <input type="text" id="dict-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="请输入字典名称（如：基础版）">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">字典类型 <span class="text-red-500">*</span></label>
              <select id="dict-type" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-white">
                <option value="">请选择字典类型</option>
                <option value="version">版本类型</option>
                <option value="resource">资源类型</option>
              </select>
            </div>
            <div id="resource-unit-section" class="hidden">
              <label class="block text-sm font-medium text-gray-700">资源单位 <span class="text-red-500">*</span></label>
              <input type="text" id="dict-unit" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="请输入资源单位（如：GB、Tokens、分钟）">
            </div>
            <div id="resource-binding-section" class="hidden">
              <label class="block text-sm font-medium text-gray-700 mb-2">资源配额配置</label>
              <div class="border border-gray-200 rounded-md p-3 space-y-3 max-h-80 overflow-y-auto" id="resource-bindings-container">
                <!-- 动态生成资源绑定项 -->
              </div>
              <p class="mt-2 text-xs text-gray-500">为每个基础资源配置在该版本下的配额数量</p>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="button" onclick="saveDictionary()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
            保存
          </button>
          <button type="button" onclick="closeDictionaryModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            取消
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let dictionaries = [];

    // 初始化字典数据（基础资源和版本的默认绑定）
    function initDictionaries() {
      dictionaries = [
        // 资源类型字典
        {
          id: 1,
          code: 'storage',
          name: '存储空间',
          type: 'resource',
          unit: 'GB'
        },
        {
          id: 2,
          code: 'aiTokens',
          name: 'AI 使用量',
          type: 'resource',
          unit: 'Tokens'
        },
        {
          id: 3,
          code: 'liveStream',
          name: '视频直播',
          type: 'resource',
          unit: '分钟'
        },
        // 版本类型字典（绑定资源及配额）
        {
          id: 4,
          code: 'base_version',
          name: '基础版',
          type: 'version',
          resourceBindings: [
            { resourceCode: 'storage', quota: 1000 },
            { resourceCode: 'aiTokens', quota: 100000 },
            { resourceCode: 'liveStream', quota: 0 }
          ]
        },
        {
          id: 5,
          code: 'premium_version',
          name: '旗舰版',
          type: 'version',
          resourceBindings: [
            { resourceCode: 'storage', quota: 5000 },
            { resourceCode: 'aiTokens', quota: 500000 },
            { resourceCode: 'liveStream', quota: 0 }
          ]
        }
      ];
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderLayout('字典管理');
      initDictionaries();
      renderDictionaryList();
      
      // 监听字典类型变化，显示/隐藏资源绑定区域
      document.getElementById('dict-type').addEventListener('change', function() {
        const resourceSection = document.getElementById('resource-binding-section');
        const unitSection = document.getElementById('resource-unit-section');
        
        if (this.value === 'version') {
          resourceSection.classList.remove('hidden');
          unitSection.classList.add('hidden');
          renderResourceBindings();
        } else if (this.value === 'resource') {
          resourceSection.classList.add('hidden');
          unitSection.classList.remove('hidden');
        } else {
          resourceSection.classList.add('hidden');
          unitSection.classList.add('hidden');
        }
      });
    });

    function renderDictionaryList() {
      const tbody = document.getElementById('dictionary-list');
      tbody.innerHTML = '';

      if (dictionaries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500 text-sm">暂无字典数据</td></tr>';
        return;
      }

      dictionaries.forEach(dict => {
        let resourceText = '-';
        if (dict.type === 'version' && dict.resourceBindings && dict.resourceBindings.length > 0) {
          // 获取资源字典名称
          const resourceNames = dict.resourceBindings.map(binding => {
            const resourceDict = dictionaries.find(d => d.code === binding.resourceCode && d.type === 'resource');
            const resourceName = resourceDict ? resourceDict.name : binding.resourceCode;
            const unit = resourceDict && resourceDict.unit ? resourceDict.unit : '';
            return `${resourceName}: ${binding.quota}${unit}`;
          });
          resourceText = resourceNames.join('；');
        } else if (dict.type === 'resource') {
          resourceText = `单位: ${dict.unit || '-'}`;
        }

        const typeText = dict.type === 'version' ? '版本类型' : '资源类型';
        const typeClass = dict.type === 'version' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800';

        tbody.innerHTML += `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${dict.code}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${dict.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${typeClass}">
                ${typeText}
              </span>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500">${resourceText}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="editDictionary(${dict.id})">编辑</button>
              <button class="text-red-600 hover:text-red-900" onclick="deleteDictionary(${dict.id})">删除</button>
            </td>
          </tr>
        `;
      });
    }

    function renderResourceBindings() {
      const container = document.getElementById('resource-bindings-container');
      container.innerHTML = '';
      
      // 获取所有资源类型的字典
      const resourceDicts = dictionaries.filter(d => d.type === 'resource');
      
      if (resourceDicts.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500">暂无资源字典，请先创建资源类型字典</p>';
        return;
      }
      
      resourceDicts.forEach(resource => {
        const bindingDiv = document.createElement('div');
        bindingDiv.className = 'flex items-center justify-between p-2 border border-gray-100 rounded hover:bg-gray-50';
        bindingDiv.innerHTML = `
          <div class="flex-1">
            <label class="text-sm font-medium text-gray-700">${resource.name}</label>
            <span class="text-xs text-gray-500 ml-2">(${resource.unit || ''})</span>
          </div>
          <input type="number" 
                 data-resource-code="${resource.code}" 
                 class="resource-quota-input w-32 border border-gray-300 rounded-md shadow-sm py-1 px-2 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                 placeholder="配额" 
                 min="0" 
                 step="1">
        `;
        container.appendChild(bindingDiv);
      });
    }

    function openAddDictionaryModal() {
      document.getElementById('dictionary-modal-title').textContent = '新增字典';
      document.getElementById('editing-dictionary-id').value = '';
      document.getElementById('dict-code').value = '';
      document.getElementById('dict-name').value = '';
      document.getElementById('dict-type').value = '';
      document.getElementById('dict-unit').value = '';
      document.getElementById('resource-binding-section').classList.add('hidden');
      document.getElementById('resource-unit-section').classList.add('hidden');
      
      document.getElementById('dictionary-modal').classList.remove('hidden');
    }
    
    window.openAddDictionaryModal = openAddDictionaryModal;

    function closeDictionaryModal() {
      document.getElementById('dictionary-modal').classList.add('hidden');
    }
    
    window.closeDictionaryModal = closeDictionaryModal;

    function editDictionary(id) {
      const dict = dictionaries.find(d => d.id === id);
      if (!dict) return;

      document.getElementById('dictionary-modal-title').textContent = '编辑字典';
      document.getElementById('editing-dictionary-id').value = id;
      document.getElementById('dict-code').value = dict.code;
      document.getElementById('dict-name').value = dict.name;
      document.getElementById('dict-type').value = dict.type;
      document.getElementById('dict-unit').value = dict.unit || '';

      // 显示/隐藏资源绑定区域
      const resourceSection = document.getElementById('resource-binding-section');
      const unitSection = document.getElementById('resource-unit-section');
      
      if (dict.type === 'version') {
        resourceSection.classList.remove('hidden');
        unitSection.classList.add('hidden');
        renderResourceBindings();
        // 设置已绑定的资源配额
        if (dict.resourceBindings) {
          dict.resourceBindings.forEach(binding => {
            const input = document.querySelector(`input[data-resource-code="${binding.resourceCode}"]`);
            if (input) {
              input.value = binding.quota;
            }
          });
        }
      } else if (dict.type === 'resource') {
        resourceSection.classList.add('hidden');
        unitSection.classList.remove('hidden');
      } else {
        resourceSection.classList.add('hidden');
        unitSection.classList.add('hidden');
      }

      document.getElementById('dictionary-modal').classList.remove('hidden');
    }
    
    window.editDictionary = editDictionary;

    function deleteDictionary(id) {
      const dict = dictionaries.find(d => d.id === id);
      if (!dict) return;

      if (confirm(`确定要删除字典 "${dict.name}" 吗？`)) {
        dictionaries = dictionaries.filter(d => d.id !== id);
        renderDictionaryList();
      }
    }
    
    window.deleteDictionary = deleteDictionary;

    function saveDictionary() {
      const id = document.getElementById('editing-dictionary-id').value;
      const code = document.getElementById('dict-code').value.trim();
      const name = document.getElementById('dict-name').value.trim();
      const type = document.getElementById('dict-type').value;

      // 必填项校验
      if (!code || !name || !type) {
        alert('请填写完整信息');
        return;
      }

      // 资源类型需要单位
      if (type === 'resource') {
        const unit = document.getElementById('dict-unit').value.trim();
        if (!unit) {
          alert('资源类型必须填写单位');
          document.getElementById('dict-unit').focus();
          return;
        }
      }

      // 检查字典编码唯一性
      const exists = dictionaries.find(d => d.code === code && (!id || d.id != id));
      if (exists) {
        alert('该字典编码已存在');
        return;
      }

      if (id) {
        // 编辑模式
        const index = dictionaries.findIndex(d => d.id == id);
        if (index !== -1) {
          if (type === 'version') {
            // 收集资源绑定及配额
            const resourceBindings = [];
            document.querySelectorAll('.resource-quota-input').forEach(input => {
              const resourceCode = input.getAttribute('data-resource-code');
              const quota = parseFloat(input.value) || 0;
              if (quota > 0) {
                resourceBindings.push({
                  resourceCode: resourceCode,
                  quota: quota
                });
              }
            });
            dictionaries[index] = {
              ...dictionaries[index],
              code,
              name,
              type,
              resourceBindings: resourceBindings
            };
          } else {
            // 资源类型
            const unit = document.getElementById('dict-unit').value.trim();
            dictionaries[index] = {
              ...dictionaries[index],
              code,
              name,
              type,
              unit: unit
            };
          }
        }
      } else {
        // 新增模式
        if (type === 'version') {
          // 收集资源绑定及配额
          const resourceBindings = [];
          document.querySelectorAll('.resource-quota-input').forEach(input => {
            const resourceCode = input.getAttribute('data-resource-code');
            const quota = parseFloat(input.value) || 0;
            if (quota > 0) {
              resourceBindings.push({
                resourceCode: resourceCode,
                quota: quota
              });
            }
          });
          dictionaries.push({
            id: Date.now(),
            code,
            name,
            type,
            resourceBindings: resourceBindings
          });
        } else {
          // 资源类型
          const unit = document.getElementById('dict-unit').value.trim();
          dictionaries.push({
            id: Date.now(),
            code,
            name,
            type,
            unit: unit
          });
        }
      }

      renderDictionaryList();
      closeDictionaryModal();
    }
    
    window.saveDictionary = saveDictionary;
  </script>
</body>
</html>
