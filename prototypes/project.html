<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>项目管理 - 企业后台管理系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="data.js"></script>
  <script src="layout.js"></script>
</head>
<body class="bg-gray-100 font-sans antialiased h-screen flex overflow-hidden" id="app">

  <!-- 侧边栏和Header通过 layout.js 动态渲染 -->

  <!-- 主内容区域容器 -->
  <div class="flex-1 flex flex-col min-w-0 bg-gray-50" id="main-content">

    <main class="flex-1 overflow-auto p-6">
      <!-- 筛选条件 -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6 overflow-hidden">
        <!-- 标题栏 -->
        <div class="bg-gray-50 px-4 py-2.5 border-b border-gray-200 flex items-center justify-between">
          <h3 class="text-xs font-semibold text-gray-700">筛选条件</h3>
          <button onclick="openCreateModal()" class="px-3 py-1.5 bg-blue-600 text-white text-xs rounded-md hover:bg-blue-700 shadow-sm flex items-center justify-center transition-colors">
            <svg class="h-3.5 w-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            新建项目
          </button>
        </div>
        
        <!-- 筛选字段 -->
        <div class="p-4">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1.5">项目名称</label>
              <input type="text" id="filter-project-name" placeholder="请输入项目名称" oninput="filterProjects()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1.5">项目版本</label>
              <select id="filter-project-version" onchange="filterProjects()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors bg-white">
                <option value="">全部版本</option>
                <option value="基础版">基础版</option>
                <option value="旗舰版">旗舰版</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1.5">所属企业</label>
              <input type="text" id="filter-enterprise" placeholder="请输入企业名称" oninput="filterProjects()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1.5">项目负责人</label>
              <input type="text" id="filter-admin" placeholder="请输入负责人姓名" oninput="filterProjects()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1.5">联系方式</label>
              <input type="text" id="filter-phone" placeholder="请输入手机号" oninput="filterProjects()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
            </div>
          </div>
        </div>
      </div>

      <!-- 项目列表表格 -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">项目名称</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">项目版本</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">所属企业</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">开通时间</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">项目负责人</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">联系方式</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">存储配额</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AI配额</th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="project-table-body">
              <!-- JS 渲染内容 -->
            </tbody>
          </table>
        </div>
        <!-- 分页 -->
        <div class="bg-white px-4 py-3 border-t border-gray-200 flex items-center justify-between sm:px-6">
          <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
              <p class="text-sm text-gray-700">
                显示 <span class="font-medium">1</span> 到 <span class="font-medium">10</span> 条，共 <span class="font-medium">20</span> 条
              </p>
            </div>
            <div>
              <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                  <span class="sr-only">上一页</span>
                  <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                  </svg>
                </a>
                <a href="#" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">1</a>
                <a href="#" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">2</a>
                <a href="#" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">3</a>
                <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                  <span class="sr-only">下一页</span>
                  <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                  </svg>
                </a>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- 侧边栏详情 (已移除，改用详情页) -->

    <!-- 新建项目模态框 -->
    <div id="create-project-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
      <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeCreateModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
          <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">新建项目</h3>
            <div class="mt-4 space-y-4">
              <div>
                <label for="new-project-name" class="block text-sm font-medium text-gray-700">项目名称 <span class="text-red-500">*</span></label>
                <input type="text" id="new-project-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="请输入项目名称">
              </div>
              <div>
                <label for="new-project-enterprise" class="block text-sm font-medium text-gray-700">所属企业 <span class="text-red-500">*</span></label>
                <select id="new-project-enterprise" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                  <!-- JS填充 -->
                </select>
              </div>
              <div>
                <label for="new-project-version" class="block text-sm font-medium text-gray-700">项目版本 <span class="text-red-500">*</span></label>
                <select id="new-project-version" required onchange="updateQuotaPreview()" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                  <option value="base">基础版</option>
                  <option value="premium">旗舰版</option>
                </select>
                <p class="mt-1 text-xs text-gray-500" id="quota-preview">含: 1000GB存储, 10万AI Tokens</p>
              </div>
              <div class="bg-gray-50 p-3 rounded-md border border-gray-200">
                <p class="text-xs text-gray-500 mb-2 font-medium">项目负责人信息 (自动创建账号并赋权)</p>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="new-admin-name" class="block text-sm font-medium text-gray-700">姓名 <span class="text-red-500">*</span></label>
                    <input type="text" id="new-admin-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="负责人姓名">
                  </div>
                  <div>
                    <label for="new-admin-phone" class="block text-sm font-medium text-gray-700">手机号 <span class="text-red-500">*</span></label>
                    <input type="text" id="new-admin-phone" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="11位手机号">
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
            <button type="button" onclick="saveNewProject()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
              创建项目
            </button>
            <button type="button" onclick="closeCreateModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
              取消
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 渲染布局
      renderLayout('项目管理');
      
      initData();
      renderTable(allProjects);
    });

    let allProjects = [];

    // 获取项目负责人的手机号
    function getProjectAdminPhone(proj) {
      // 1. 先从teamMembers中查找匹配的成员
      if (proj.teamMembers && proj.teamMembers.length > 0) {
        const adminMember = proj.teamMembers.find(m => m.name === proj.projectAdmin);
        if (adminMember && adminMember.phone) {
          return adminMember.phone;
        }
        // 如果没有找到匹配的，取第一个成员的手机号
        if (proj.teamMembers[0].phone) {
          return proj.teamMembers[0].phone;
        }
      }
      
      // 2. 从mockData.users中查找
      if (typeof mockData !== 'undefined' && mockData.users) {
        const user = mockData.users.find(u => u.fullName === proj.projectAdmin || u.phone === proj.projectAdmin);
        if (user && user.phone) {
          return user.phone;
        }
      }
      
      // 3. 生成示例手机号（基于项目负责人姓名，生成一个11位手机号）
      // 这里为了演示，生成一个固定的示例号码
      const phoneMap = {
        '李博迪': '13800138001',
        '陈明浩': '13800138002',
        '赵奔': '13800138003'
      };
      
      if (phoneMap[proj.projectAdmin]) {
        return phoneMap[proj.projectAdmin];
      }
      
      // 默认生成一个示例手机号
      return '13800000000';
    }

    function initData() {
        allProjects = [];
        mockData.enterprises.forEach(ent => {
          ent.projects.forEach(proj => {
            allProjects.push({ ...proj, enterpriseName: ent.name });
          });
        });
    }

    function filterProjects() {
        const nameFilter = document.getElementById('filter-project-name').value.toLowerCase();
        const versionFilter = document.getElementById('filter-project-version').value;
        const enterpriseFilter = document.getElementById('filter-enterprise').value.toLowerCase();
        const adminFilter = document.getElementById('filter-admin').value.toLowerCase();
        const phoneFilter = document.getElementById('filter-phone').value;
        
        const filtered = allProjects.filter(p => {
            const matchName = !nameFilter || p.name.toLowerCase().includes(nameFilter);
            const matchVersion = !versionFilter || (p.version || '基础版') === versionFilter;
            const matchEnterprise = !enterpriseFilter || p.enterpriseName.toLowerCase().includes(enterpriseFilter);
            const matchAdmin = !adminFilter || p.projectAdmin.toLowerCase().includes(adminFilter);
            const adminPhone = getProjectAdminPhone(p);
            const matchPhone = !phoneFilter || adminPhone.includes(phoneFilter);
            
            return matchName && matchVersion && matchEnterprise && matchAdmin && matchPhone;
        });
        
        renderTable(filtered);
    }

    function renderTable(projects) {
      const tbody = document.getElementById('project-table-body');
      tbody.innerHTML = '';
      
      if (projects.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-10 text-center text-gray-500">没有找到匹配的项目</td></tr>';
        return;
      }

      projects.forEach(proj => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 transition-colors cursor-pointer';
        tr.onclick = () => window.location.href = `project-detail.html?id=${proj.id}`;
        
        const statusClass = proj.status === '进行中' ? 'bg-green-100 text-green-800' : 
                            proj.status === '已暂停' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800';

        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">
              <a href="project-detail.html?id=${proj.id}" class="text-blue-600 hover:text-blue-900 hover:underline" onclick="event.stopPropagation()">
                ${proj.name}
              </a>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
             <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${proj.version === '旗舰版' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">
               ${proj.version || '基础版'}
             </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${proj.enterpriseName}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${proj.createdAt || '2024-01-15'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${proj.projectAdmin}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${getProjectAdminPhone(proj)}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
             ${proj.storageUsed} / ${proj.quota && proj.quota.storage ? proj.quota.storage.total : proj.allocatedQuota / 2} GB
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
             ${proj.aiUsed} / ${proj.quota && proj.quota.aiTokens ? proj.quota.aiTokens.total : proj.allocatedQuota / 2}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <a href="project-detail.html?id=${proj.id}" class="text-blue-600 hover:text-blue-900" onclick="event.stopPropagation()">查看详情</a>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 移除 Slide-Over 相关函数
    
    function openCreateModal() {
      // 填充企业下拉框
      const entSelect = document.getElementById('new-project-enterprise');
      entSelect.innerHTML = '';
      mockData.enterprises.forEach(ent => {
        const option = document.createElement('option');
        option.value = ent.id;
        option.textContent = ent.name;
        entSelect.appendChild(option);
      });
      
      document.getElementById('create-project-modal').classList.remove('hidden');
    }

    function closeCreateModal() {
      document.getElementById('create-project-modal').classList.add('hidden');
    }

    function updateQuotaPreview() {
      const version = document.getElementById('new-project-version').value;
      const preview = document.getElementById('quota-preview');
      if (version === 'base') {
        preview.textContent = '含: 1000GB存储, 10万AI Tokens';
      } else {
        preview.textContent = '含: 5000GB存储, 50万AI Tokens';
      }
    }

    function saveNewProject() {
      const name = document.getElementById('new-project-name').value;
      const entId = parseInt(document.getElementById('new-project-enterprise').value);
      const version = document.getElementById('new-project-version').value;
      const adminName = document.getElementById('new-admin-name').value;
      const adminPhone = document.getElementById('new-admin-phone').value;
      
      // Auto-assign quota based on version
      let storage, ai;
      let verName = "标准版";
      if (version === 'base') {
        storage = 1000;
        ai = 100000;
        verName = "基础版";
      } else {
        storage = 5000;
        ai = 500000;
        verName = "旗舰版";
      }

      if (!name || !adminName || !adminPhone || !version) {
        alert("请填写完整的项目信息和负责人信息");
        return;
      }
      
      if (version !== 'base' && version !== 'premium') {
        alert("请选择有效的项目版本");
        return;
      }
      
      if (!/^1[3-9]\d{9}$/.test(adminPhone)) {
        alert("请输入正确的11位手机号");
        return;
      }

      // 1. 创建项目对象
      const newProject = {
        id: Date.now(),
        name: name,
        version: verName,
        description: "新创建的项目",
        projectAdmin: adminName,
        allocatedQuota: storage * 2 + ai, // 简单模拟
        storageUsed: 0,
        aiUsed: 0,
        status: "进行中",
        quota: {
           storage: { total: storage, used: 0, unit: "GB" },
           aiTokens: { total: ai, used: 0 },
           baseLicense: { total: 10, used: 0 },
           premiumLicense: { total: 2, used: 0 },
           liveStream: { total: 100, used: 0, unit: "分钟" }
        },
        devices: [],
        teamMembers: [
          {
            id: Date.now() + 1,
            name: adminName,
            role: "项目管理员",
            phone: adminPhone
          }
        ],
        subcontractors: []
      };

      // 2. 将项目添加到对应企业
      const enterprise = mockData.enterprises.find(e => e.id === entId);
      if (enterprise) {
        enterprise.projects.push(newProject);
      }

      // 3. 处理用户逻辑 (检查是否已存在，不存在则新建)
      let existingUser = null;
      if (mockData.users) {
        existingUser = mockData.users.find(u => u.username === adminPhone);
      }
      
      if (!existingUser) {
        // 创建新用户
        const newUser = {
          id: Date.now() + 2,
          username: adminPhone,
          fullName: adminName,
          phone: adminPhone,
          role: "项目管理员",
          enterprise: enterprise ? enterprise.name : "未知企业",
          project: name, // 绑定到新项目
          status: "激活",
          createdAt: new Date().toISOString().split('T')[0]
        };
        if (mockData.users) {
          mockData.users.push(newUser);
        }
        alert(`项目 "${name}" 创建成功！\n已自动创建负责人账号：${adminPhone}\n初始密码：123456`);
      } else {
         alert(`项目 "${name}" 创建成功！\n负责人账号 ${adminPhone} 已存在，已自动赋予该项目管理权限。`);
         // 实际逻辑中这里应该更新已有用户的关联信息，或者在关联表中添加记录
         // 这里仅演示提示信息
      }

      closeCreateModal();
      
      // 刷新列表
      initData();
      renderTable(allProjects);
    }
  </script>
</body>
</html>

