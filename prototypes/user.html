<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>用户管理 - 企业后台管理系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="data.js"></script>
  <script src="layout.js"></script>
</head>
<body class="bg-gray-100 font-sans antialiased h-screen flex overflow-hidden" id="app">

  <!-- 侧边栏和Header通过 layout.js 动态渲染 -->

  <!-- 主内容区域容器 -->
  <div class="flex-1 flex flex-col min-w-0 bg-gray-50" id="main-content">

    <main class="flex-1 overflow-auto p-6">
      <!-- 筛选条件 -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6 overflow-hidden">
        <!-- 标题栏 -->
        <div class="bg-gray-50 px-4 py-2.5 border-b border-gray-200 flex items-center justify-between">
          <h3 class="text-xs font-semibold text-gray-700">筛选条件</h3>
          <button onclick="openModal('add')" class="px-3 py-1.5 bg-blue-600 text-white text-xs rounded-md hover:bg-blue-700 shadow-sm flex items-center justify-center transition-colors">
            <svg class="h-3.5 w-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            新增用户
          </button>
        </div>
        
        <!-- 筛选字段 -->
        <div class="p-4">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1.5">姓名</label>
              <input type="text" id="filter-user-name" placeholder="请输入姓名" oninput="filterUsers()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1.5">手机号</label>
              <input type="text" id="filter-user-phone" placeholder="请输入手机号" oninput="filterUsers()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1.5">状态</label>
              <select id="filter-user-status" onchange="filterUsers()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors bg-white">
                <option value="">全部状态</option>
                <option value="激活">激活</option>
                <option value="禁用">禁用</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- 用户列表表格 -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">账号/手机号</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="user-table-body">
              <!-- JS渲染 -->
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- 新增/编辑用户 模态框 -->
    <div id="user-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
      <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <!-- 遮罩 -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        
        <!-- 模态框内容 -->
        <form id="user-form" class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
          <input type="hidden" id="user-id">
          <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <div class="sm:flex sm:items-start">
              <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">新增用户</h3>
                <div class="mt-4 space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700">手机号 (登录账号) <span class="text-red-500">*</span></label>
                    <input type="text" id="form-username" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="请输入11位手机号">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">姓名 <span class="text-red-500">*</span></label>
                    <input type="text" id="form-fullname" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="请输入姓名">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">状态 <span class="text-red-500">*</span></label>
                    <select id="form-status" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white">
                      <option value="">请选择状态</option>
                      <option value="激活">激活</option>
                      <option value="禁用">禁用</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
            <button type="button" onclick="saveUser()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
              保存
            </button>
            <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" onclick="closeModal()">
              取消
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 重置密码模态框 -->
    <div id="reset-password-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
      <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeResetPasswordModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
          <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <div class="sm:flex sm:items-start">
              <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 sm:mx-0 sm:h-10 sm:w-10">
                <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
              </div>
              <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">重置密码</h3>
                <div class="mt-2">
                  <input type="hidden" id="reset-password-user-id">
                  <p class="text-sm text-gray-500">
                    确定要重置用户 <strong id="reset-password-user-name"></strong> (手机号: <strong id="reset-password-user-phone"></strong>) 的密码吗？
                  </p>
                  <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                    <p class="text-sm text-yellow-800">
                      <strong>提示：</strong>重置后密码将恢复为默认密码：<strong>Azm2025@</strong>
                    </p>
                    <p class="text-xs text-yellow-700 mt-1">请提醒用户登录后及时修改密码</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
            <button type="button" onclick="confirmResetPassword()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-yellow-600 text-base font-medium text-white hover:bg-yellow-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
              确认重置
            </button>
            <button type="button" onclick="closeResetPasswordModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
              取消
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    let users = [];

    document.addEventListener('DOMContentLoaded', () => {
      renderLayout('用户管理');
      users = [...mockData.users]; // 复制一份数据
      renderTable(users);
    });

    function filterUsers() {
      const nameFilter = document.getElementById('filter-user-name').value.toLowerCase();
      const phoneFilter = document.getElementById('filter-user-phone').value;
      const statusFilter = document.getElementById('filter-user-status').value;
      
      const filtered = users.filter(u => {
        const matchName = !nameFilter || (u.fullName && u.fullName.toLowerCase().includes(nameFilter));
        const matchPhone = !phoneFilter || (u.username && u.username.includes(phoneFilter)) || (u.phone && u.phone.includes(phoneFilter));
        const matchStatus = !statusFilter || u.status === statusFilter;
        
        return matchName && matchPhone && matchStatus;
      });
      
      renderTable(filtered);
    }

    function renderTable(data) {
      const tbody = document.getElementById('user-table-body');
      tbody.innerHTML = '';
      
      data.forEach(user => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 transition-colors';
        
        const statusClass = user.status === '激活' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';

        const fullName = user.fullName || '-';
        const username = user.username || user.phone || '-';
        const status = user.status || '激活';
        
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${fullName}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${username}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
              ${status}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="openModal('edit', ${user.id})">编辑</button>
            <button class="text-yellow-600 hover:text-yellow-900 mr-3" onclick="resetPassword(${user.id})">重置密码</button>
            <button class="text-red-600 hover:text-red-900" onclick="deleteUser(${user.id})">删除</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function openModal(mode, userId = null) {
      const modal = document.getElementById('user-modal');
      const title = document.getElementById('modal-title');
      const form = document.getElementById('user-form');
      
      form.reset();

      if (mode === 'edit') {
        title.textContent = '编辑用户';
        const user = users.find(u => u.id === userId);
        if (user) {
          document.getElementById('user-id').value = user.id;
          document.getElementById('form-username').value = user.username || '';
          document.getElementById('form-fullname').value = user.fullName || '';
          document.getElementById('form-status').value = user.status || '激活';
        }
      } else {
        title.textContent = '新增用户';
        document.getElementById('user-id').value = '';
        document.getElementById('form-status').value = '激活'; // 新增用户默认激活
      }
      
      modal.classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('user-modal').classList.add('hidden');
    }

    function saveUser() {
      const id = document.getElementById('user-id').value;
      const username = document.getElementById('form-username').value.trim(); // 实际是手机号
      const fullName = document.getElementById('form-fullname').value.trim();
      const status = document.getElementById('form-status').value;

      // 必填项校验
      if (!username) {
        alert('请填写手机号');
        document.getElementById('form-username').focus();
        return;
      }

      if (!fullName) {
        alert('请填写姓名');
        document.getElementById('form-fullname').focus();
        return;
      }

      if (!status) {
        alert('请选择状态');
        document.getElementById('form-status').focus();
        return;
      }

      // 手机号正则校验
      const phoneRegex = /^1[3-9]\d{9}$/;
      if (!phoneRegex.test(username)) {
        alert('请输入有效的11位手机号');
        document.getElementById('form-username').focus();
        return;
      }

      // 手机号唯一性校验
      const existingUser = users.find(u => u.username === username && u.id != id);
      if (existingUser) {
        alert('该手机号已被注册');
        document.getElementById('form-username').focus();
        return;
      }

      if (id) {
        // 编辑
        const index = users.findIndex(u => u.id == id);
        if (index !== -1) {
          users[index] = { ...users[index], username, fullName, phone: username, status };
        }
        // 同时更新mockData.users
        const mockIndex = mockData.users.findIndex(u => u.id == id);
        if (mockIndex !== -1) {
          mockData.users[mockIndex] = { ...mockData.users[mockIndex], username, fullName, phone: username, status };
        }
      } else {
        // 新增
        const newUser = {
          id: Date.now(),
          username, // 手机号作为用户名
          fullName,
          phone: username, // 同时存入 phone 字段
          status: status,
          role: '普通用户',
          enterprise: '-',
          project: '-',
          createdAt: new Date().toISOString().split('T')[0]
        };
        users.unshift(newUser);
        // 同时添加到mockData.users
        if (mockData.users) {
          mockData.users.unshift(newUser);
        }
      }

      closeModal();
      // 重新渲染（应用当前筛选条件）
      filterUsers();
    }

    function deleteUser(id) {
      if (confirm('确定要删除该用户吗？')) {
        users = users.filter(u => u.id !== id);
        // 同时从mockData.users中删除
        if (mockData.users) {
          mockData.users = mockData.users.filter(u => u.id !== id);
        }
        // 重新渲染（应用当前筛选条件）
        filterUsers();
      }
    }

    function resetPassword(id) {
      const user = users.find(u => u.id === id);
      if (!user) return;

      // 设置要重置密码的用户信息
      document.getElementById('reset-password-user-id').value = id;
      document.getElementById('reset-password-user-name').textContent = user.fullName || user.username;
      document.getElementById('reset-password-user-phone').textContent = user.username || user.phone || '-';
      
      // 显示重置密码模态框
      document.getElementById('reset-password-modal').classList.remove('hidden');
    }
    
    window.resetPassword = resetPassword;

    function closeResetPasswordModal() {
      document.getElementById('reset-password-modal').classList.add('hidden');
    }
    
    window.closeResetPasswordModal = closeResetPasswordModal;

    function confirmResetPassword() {
      const id = document.getElementById('reset-password-user-id').value;
      const user = users.find(u => u.id == id);
      if (!user) return;

      // 这里可以调用实际的密码重置API
      // 目前只是模拟
      alert(`用户 "${user.fullName || user.username}" 的密码已重置为默认密码：Azm2025@`);
      
      closeResetPasswordModal();
    }
    
    window.confirmResetPassword = confirmResetPassword;
  </script>
</body>
</html>
