<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>企业管理 - 企业后台管理系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="data.js"></script>
  <script src="layout.js"></script>
  <style>
    /* 自定义滚动条样式 */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1; 
    }
    ::-webkit-scrollbar-thumb {
      background: #ccc; 
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #999; 
    }
  </style>
</head>
<body class="bg-gray-100 font-sans antialiased h-screen flex overflow-hidden" id="app">

  <!-- 侧边栏和Header通过 layout.js 动态渲染 -->

  <!-- 主内容区域容器 -->
  <div class="flex-1 flex flex-col min-w-0 bg-gray-50" id="main-content">
    
    <!-- 主视图 -->
    <main class="flex-1 overflow-auto p-6">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
        
        <!-- 左侧：组织树形列表 -->
        <div class="lg:col-span-3 flex flex-col h-full bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <h3 class="font-semibold text-gray-700">组织架构</h3>
            <div class="flex space-x-2">
              <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="openAddEnterpriseModal(null)">+ 新增企业</button>
            </div>
          </div>
          <div class="flex-1 overflow-y-auto p-2" id="enterprise-tree">
            <!-- 组织列表将通过JS渲染在这里 -->
          </div>
        </div>

        <!-- 右侧：组织详情与统计 -->
        <div class="lg:col-span-9 flex flex-col gap-6 overflow-y-auto">
          
          <!-- 组织基本信息卡片 -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex justify-between items-start mb-6">
              <div>
                <h2 class="text-2xl font-bold text-gray-900" id="detail-name">选择组织</h2>
              </div>
              <div class="flex space-x-2 relative">
                <button onclick="openEditEnterpriseModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium shadow-sm">编辑信息</button>
                <div class="relative">
                  <button onclick="toggleMoreActionsMenu()" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium shadow-sm flex items-center">
                    更多操作
                    <svg class="ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </button>
                  <div id="more-actions-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 border border-gray-200">
                    <div class="py-1">
                      <button onclick="exportEnterpriseData()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <svg class="inline-block h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        导出数据
                      </button>
                      <button onclick="openDeleteEnterpriseModal()" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                        <svg class="inline-block h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        删除组织
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tabs -->
            <div class="border-b border-gray-200 mb-6">
              <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                  概览
                </button>
                <button onclick="switchTab('projects')" id="tab-projects" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                  项目列表
                </button>
                <button onclick="switchTab('devices')" id="tab-devices" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                  设备列表
                </button>
                <button onclick="switchTab('members')" id="tab-members" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                  成员列表
                </button>
              </nav>
            </div>

            <!-- 概览内容 -->
            <div id="content-overview" class="tab-content">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-100">
                  <p class="text-sm text-gray-500 mb-1">管理员</p>
                  <p class="font-medium text-gray-900" id="detail-contact">-</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-100">
                  <p class="text-sm text-gray-500 mb-1">注册时间</p>
                  <p class="font-medium text-gray-900" id="detail-date">-</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-100 cursor-pointer hover:bg-gray-100 transition-colors" onclick="switchTab('projects')">
                  <p class="text-sm text-gray-500 mb-1">项目总数</p>
                  <p class="font-medium text-gray-900" id="detail-projects-count">0</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-100">
                  <p class="text-sm text-gray-500 mb-1">可用额度</p>
                  <a href="javascript:void(0)" onclick="openQuotaConsumptionModal()" class="font-medium text-green-600 hover:text-green-700 hover:underline" id="detail-quota">查看详情</a>
                </div>
              </div>

              <!-- 资源配额使用情况 -->
              <h3 class="font-semibold text-gray-800 mb-4 mt-6">资源配额使用情况</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="resource-grid">
                <!-- JS 动态生成卡片 -->
              </div>

              <!-- 统计图表区域 (移入概览 Tab) -->
              <div class="mt-8 bg-white rounded-xl border border-gray-200 p-6">
                <h3 class="font-semibold text-gray-800 mb-4">资源使用趋势 (近6个月)</h3>
                <div class="h-64">
                  <canvas id="resourceChart"></canvas>
                </div>
              </div>
            </div>

            <!-- 项目列表内容 -->
            <div id="content-projects" class="tab-content hidden">
              <div class="mb-4 flex justify-between items-center">
                <button onclick="openCreateProjectModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm text-sm font-medium">
                  + 新建项目
                </button>
              </div>
              
              <!-- 筛选框 -->
              <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">项目名称</label>
                    <input type="text" id="project-filter-name" placeholder="搜索项目名称" oninput="filterProjectList()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">项目版本</label>
                    <select id="project-filter-version" onchange="filterProjectList()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                      <option value="">全部版本</option>
                      <option value="基础版">基础版</option>
                      <option value="旗舰版">旗舰版</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">项目负责人</label>
                    <input type="text" id="project-filter-admin" placeholder="搜索项目负责人" oninput="filterProjectList()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">负责人电话</label>
                    <input type="text" id="project-filter-phone" placeholder="搜索电话" oninput="filterProjectList()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  </div>
                </div>
              </div>
              
              <div class="overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">项目名称</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">项目版本</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">项目负责人</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">负责人电话</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">存储使用</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">AI 使用</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200" id="project-list-body">
                    <!-- 项目列表 -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 设备列表内容 -->
            <div id="content-devices" class="tab-content hidden">
              <!-- 筛选框 -->
              <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">设备名称</label>
                    <input type="text" id="device-filter-name" placeholder="搜索设备名称" oninput="filterDeviceList()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">设备类型</label>
                    <select id="device-filter-type" onchange="filterDeviceList()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                      <option value="">全部类型</option>
                      <option value="摄像头">摄像头</option>
                      <option value="传感器">传感器</option>
                      <option value="网关">网关</option>
                      <option value="其他">其他</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">所属项目</label>
                    <input type="text" id="device-filter-project" placeholder="搜索项目" oninput="filterDeviceList()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">设备状态</label>
                    <select id="device-filter-status" onchange="filterDeviceList()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                      <option value="">全部状态</option>
                      <option value="online">在线</option>
                      <option value="offline">离线</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">设备名称</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">类型</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">所属项目</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">位置</th>
                      <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">状态</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200" id="device-list-body">
                    <!-- 设备列表 -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 成员列表内容 -->
            <div id="content-members" class="tab-content hidden">
              <div class="mb-4 flex justify-between items-center">
                <button onclick="openAddMemberModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm text-sm font-medium">
                  + 新增成员
                </button>
              </div>
              
              <!-- 筛选框 -->
              <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">手机号</label>
                    <input type="text" id="member-filter-phone" placeholder="搜索手机号" oninput="filterMemberList()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">姓名</label>
                    <input type="text" id="member-filter-name" placeholder="搜索姓名" oninput="filterMemberList()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">角色</label>
                    <input type="text" id="member-filter-role" placeholder="搜索角色" oninput="filterMemberList()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  </div>
                </div>
              </div>

              <div class="overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">手机号</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">姓名</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">角色</th>
                      <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">操作</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200" id="member-list-body">
                    <!-- 成员列表 -->
                  </tbody>
                </table>
              </div>
            </div>

          </div>
          
          <!-- 旧的统计图表区域 (已移入 Tabs) -->
        </div>

        </div>
      </div>
    </main>
  </div>

  <!-- Add Enterprise Modal -->
  <div id="add-enterprise-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeAddEnterpriseModal()"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">新增组织节点</h3>
          <div class="mt-4 space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">父节点</label>
              <select id="new-ent-parent" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <option value="">无（创建根节点）</option>
                <!-- JS动态填充 -->
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">节点类型 <span class="text-red-500">*</span></label>
              <select id="new-ent-type" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <option value="部门">部门</option>
                <option value="分公司">分公司</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">节点名称 <span class="text-red-500">*</span></label>
              <input type="text" id="new-ent-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            
            <!-- 套餐额度配置 -->
            <div class="bg-blue-50 p-3 rounded-md border border-blue-200">
               <p class="text-xs text-blue-700 mb-2 font-medium">初始资源配额配置</p>
               
               <!-- 版本资源 (输入) -->
               <div class="mb-4 pb-4 border-b border-blue-200">
                 <p class="text-xs text-blue-600 mb-2 font-medium">版本账号数量</p>
                 <div class="grid grid-cols-2 gap-4">
                   <div>
                     <label class="block text-sm font-medium text-gray-700">基础版账号 <span class="text-red-500">*</span></label>
                     <input type="number" id="new-quota-base" value="20" min="0" required oninput="calculateResources()" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                     <p class="text-xs text-gray-500 mt-1">含: 10G存储, 1万AI</p>
                   </div>
                   <div>
                     <label class="block text-sm font-medium text-gray-700">旗舰版账号 <span class="text-red-500">*</span></label>
                     <input type="number" id="new-quota-premium" value="5" min="0" required oninput="calculateResources()" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                     <p class="text-xs text-gray-500 mt-1">含: 100G存储, 10万AI, 100分直播</p>
                   </div>
                 </div>
               </div>

               <!-- 基础资源 (自动计算) -->
               <div>
                 <p class="text-xs text-blue-600 mb-2 font-medium">基础资源 (自动叠加)</p>
                 <div class="grid grid-cols-3 gap-4 text-center">
                   <div class="bg-white p-2 rounded border border-blue-100">
                     <p class="text-xs text-gray-500">存储空间</p>
                     <p class="font-bold text-blue-700" id="calc-storage">0 GB</p>
                   </div>
                   <div class="bg-white p-2 rounded border border-blue-100">
                     <p class="text-xs text-gray-500">AI Tokens</p>
                     <p class="font-bold text-blue-700" id="calc-ai">0</p>
                   </div>
                   <div class="bg-white p-2 rounded border border-blue-100">
                     <p class="text-xs text-gray-500">直播时长</p>
                     <p class="font-bold text-blue-700" id="calc-live">0 分钟</p>
                   </div>
                 </div>
               </div>
            </div>

            <div class="bg-gray-50 p-3 rounded-md border border-gray-200">
               <p class="text-xs text-gray-500 mb-2 font-medium">节点管理员信息</p>
               <p class="text-xs text-gray-400 mb-3">为当前节点设置管理员，管理员可以管理该节点及其所有子节点</p>
               <div class="grid grid-cols-2 gap-4">
                 <div>
                   <label class="block text-sm font-medium text-gray-700">姓名 <span class="text-red-500">*</span></label>
                   <input type="text" id="new-ent-admin-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                 </div>
                 <div>
                   <label class="block text-sm font-medium text-gray-700">手机号 <span class="text-red-500">*</span></label>
                   <input type="text" id="new-ent-admin-phone" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                 </div>
               </div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="button" onclick="saveNewEnterprise()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
            保存
          </button>
          <button type="button" onclick="closeAddEnterpriseModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            取消
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Enterprise Modal -->
  <div id="edit-enterprise-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="edit-modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeEditEnterpriseModal()"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <h3 class="text-lg leading-6 font-medium text-gray-900" id="edit-modal-title">编辑组织信息</h3>
          <div class="mt-4 space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">组织名称 <span class="text-red-500">*</span></label>
              <input type="text" id="edit-ent-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            
            <!-- 套餐额度配置 -->
            <div class="bg-blue-50 p-3 rounded-md border border-blue-200">
               <p class="text-xs text-blue-700 mb-2 font-medium">资源配额配置</p>
               
               <!-- 版本资源 (输入) -->
               <div class="mb-4 pb-4 border-b border-blue-200">
                 <p class="text-xs text-blue-600 mb-2 font-medium">版本账号数量</p>
                 <div class="grid grid-cols-2 gap-4">
                   <div>
                     <label class="block text-sm font-medium text-gray-700">基础版账号 <span class="text-red-500">*</span></label>
                     <input type="number" id="edit-quota-base" min="0" required oninput="calculateEditResources()" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                     <p class="text-xs text-gray-500 mt-1">含: 10G存储, 1万AI</p>
                   </div>
                   <div>
                     <label class="block text-sm font-medium text-gray-700">旗舰版账号 <span class="text-red-500">*</span></label>
                     <input type="number" id="edit-quota-premium" min="0" required oninput="calculateEditResources()" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                     <p class="text-xs text-gray-500 mt-1">含: 100G存储, 10万AI, 100分直播</p>
                   </div>
                 </div>
               </div>

               <!-- 基础资源 (自动计算) -->
               <div>
                 <p class="text-xs text-blue-600 mb-2 font-medium">基础资源 (自动叠加)</p>
                 <div class="grid grid-cols-3 gap-4 text-center">
                   <div class="bg-white p-2 rounded border border-blue-100">
                     <p class="text-xs text-gray-500">存储空间</p>
                     <p class="font-bold text-blue-700" id="edit-calc-storage">0 GB</p>
                   </div>
                   <div class="bg-white p-2 rounded border border-blue-100">
                     <p class="text-xs text-gray-500">AI Tokens</p>
                     <p class="font-bold text-blue-700" id="edit-calc-ai">0</p>
                   </div>
                   <div class="bg-white p-2 rounded border border-blue-100">
                     <p class="text-xs text-gray-500">直播时长</p>
                     <p class="font-bold text-blue-700" id="edit-calc-live">0 分钟</p>
                   </div>
                 </div>
               </div>
            </div>

            <div class="bg-gray-50 p-3 rounded-md border border-gray-200">
               <p class="text-xs text-gray-500 mb-2 font-medium">节点管理员信息</p>
               <div class="grid grid-cols-2 gap-4">
                 <div>
                   <label class="block text-sm font-medium text-gray-700">姓名 <span class="text-red-500">*</span></label>
                   <input type="text" id="edit-ent-admin-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                 </div>
                 <div>
                   <label class="block text-sm font-medium text-gray-700">手机号 <span class="text-red-500">*</span></label>
                   <input type="text" id="edit-ent-admin-phone" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                 </div>
               </div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="button" onclick="saveEditEnterprise()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
            保存
          </button>
          <button type="button" onclick="closeEditEnterpriseModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            取消
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Enterprise Confirmation Modal -->
  <div id="delete-enterprise-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="delete-modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeDeleteEnterpriseModal()"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
              <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
            </div>
            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
              <h3 class="text-lg leading-6 font-medium text-gray-900" id="delete-modal-title">删除组织</h3>
              <div class="mt-2">
                <p class="text-sm text-gray-500">
                  确定要删除组织 "<span id="delete-enterprise-name" class="font-semibold text-gray-900"></span>" 吗？此操作不可恢复，将同时删除该组织下的所有项目和关联数据。
                </p>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="button" onclick="confirmDeleteEnterprise()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
            确认删除
          </button>
          <button type="button" onclick="closeDeleteEnterpriseModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            取消
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quota Consumption Detail Modal -->
  <div id="quota-consumption-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="quota-modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeQuotaConsumptionModal()"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-6xl w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" id="quota-modal-title">额度消费记录</h3>
          
          <!-- 筛选框 -->
          <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">资源类型</label>
                <select id="quota-filter-type" onchange="filterQuotaConsumption()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  <option value="">全部类型</option>
                  <option value="storage">存储空间</option>
                  <option value="aiTokens">AI 使用量</option>
                  <option value="liveStream">视频直播</option>
                  <option value="baseLicense">基础版账号</option>
                  <option value="premiumLicense">旗舰版账号</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">项目名称</label>
                <input type="text" id="quota-filter-project" placeholder="搜索项目" oninput="filterQuotaConsumption()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">开始日期</label>
                <input type="date" id="quota-filter-start" onchange="filterQuotaConsumption()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">结束日期</label>
                <input type="date" id="quota-filter-end" onchange="filterQuotaConsumption()" class="block w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-3 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>
          </div>

          <!-- 表格 -->
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">时间</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">资源类型</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">项目名称</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">消费量</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作类型</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200" id="quota-consumption-body">
                <!-- JS 渲染 -->
              </tbody>
            </table>
          </div>

          <!-- 分页控件 -->
          <div class="bg-white px-4 py-3 border-t border-gray-200 flex items-center justify-between sm:px-6 mt-4">
            <div class="flex-1 flex justify-between sm:hidden">
              <button onclick="changeQuotaPage(currentQuotaPage - 1)" id="quota-prev-btn-mobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                上一页
              </button>
              <button onclick="changeQuotaPage(currentQuotaPage + 1)" id="quota-next-btn-mobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                下一页
              </button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
              <div>
                <p class="text-sm text-gray-700">
                  显示 <span class="font-medium" id="quota-page-start">1</span> 到 <span class="font-medium" id="quota-page-end">10</span> 条，共 <span class="font-medium" id="quota-total-count">0</span> 条
                </p>
              </div>
              <div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                  <button onclick="changeQuotaPage(currentQuotaPage - 1)" id="quota-prev-btn" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <span class="sr-only">上一页</span>
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                  </button>
                  <div id="quota-page-numbers" class="flex">
                    <!-- 页码按钮将通过JS动态生成 -->
                  </div>
                  <button onclick="changeQuotaPage(currentQuotaPage + 1)" id="quota-next-btn" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <span class="sr-only">下一页</span>
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </nav>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="button" onclick="closeQuotaConsumptionModal()" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:ml-3 sm:w-auto sm:text-sm">
            关闭
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Member Modal -->
  <div id="member-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="member-modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeMemberModal()"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <h3 class="text-lg leading-6 font-medium text-gray-900" id="member-modal-title">新增成员</h3>
          <div class="mt-4 space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">手机号 <span class="text-red-500">*</span></label>
              <input type="text" id="member-phone" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="11位手机号">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">姓名 <span class="text-red-500">*</span></label>
              <input type="text" id="member-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="请输入姓名">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">角色 <span class="text-red-500">*</span></label>
              <select id="member-role" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <option value="">请选择角色</option>
                <option value="企业平台主管">企业平台主管</option>
                <option value="项目平台主管">项目平台主管</option>
                <option value="普通用户">普通用户</option>
                <option value="财务">财务</option>
                <option value="运营">运营</option>
              </select>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="button" onclick="saveMember()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
            保存
          </button>
          <button type="button" onclick="closeMemberModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            取消
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Project Modal (shared with project.html) -->
  <div id="create-project-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeCreateProjectModal()"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <h3 class="text-lg leading-6 font-medium text-gray-900" id="create-project-modal-title">新建项目</h3>
          <div class="mt-4 space-y-4">
            <div>
              <label for="new-project-name" class="block text-sm font-medium text-gray-700">项目名称 <span class="text-red-500">*</span></label>
              <input type="text" id="new-project-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="请输入项目名称">
            </div>
            <div>
              <label for="new-project-enterprise" class="block text-sm font-medium text-gray-700">所属企业 <span class="text-red-500">*</span></label>
              <select id="new-project-enterprise" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <!-- JS填充 -->
              </select>
            </div>
            <div>
              <label for="new-project-version" class="block text-sm font-medium text-gray-700">项目版本 <span class="text-red-500">*</span></label>
              <select id="new-project-version" required onchange="updateQuotaPreview()" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <option value="base">基础版</option>
                <option value="premium">旗舰版</option>
              </select>
              <p class="mt-1 text-xs text-gray-500" id="quota-preview">含: 1000GB存储, 10万AI Tokens</p>
            </div>
            <div class="bg-gray-50 p-3 rounded-md border border-gray-200">
              <p class="text-xs text-gray-500 mb-2 font-medium">项目负责人信息 (自动创建账号并赋权)</p>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="new-admin-name" class="block text-sm font-medium text-gray-700">姓名 <span class="text-red-500">*</span></label>
                  <input type="text" id="new-admin-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="负责人姓名">
                </div>
                <div>
                  <label for="new-admin-phone" class="block text-sm font-medium text-gray-700">手机号 <span class="text-red-500">*</span></label>
                  <input type="text" id="new-admin-phone" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="11位手机号">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="button" onclick="saveNewProjectFromEnterprise()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
            创建项目
          </button>
          <button type="button" onclick="closeCreateProjectModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            取消
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const RESOURCE_RULES = {
      base: { storage: 10, ai: 10000, live: 0 }, // GB, Tokens, Mins
      premium: { storage: 100, ai: 100000, live: 100 }
    };

    function openAddEnterpriseModal(parentId = null) {
      // 填充父节点下拉框
      const parentSelect = document.getElementById('new-ent-parent');
      parentSelect.innerHTML = '<option value="">无（创建根节点）</option>';
      
      // 如果指定了父节点，禁用下拉框并自动选中
      if (parentId) {
        parentSelect.disabled = true;
        
        // 查找父节点信息并填充
        const orgs = mockData.organizations || mockData.enterprises;
        const parentNode = orgs.find(n => n.id === parentId);
        if (parentNode) {
          const option = document.createElement('option');
          option.value = parentNode.id;
          option.textContent = `${parentNode.type || '企业'} - ${parentNode.name}`;
          option.selected = true;
          parentSelect.appendChild(option);
        }
      } else {
        // 没有指定父节点，启用下拉框并填充可选节点
        parentSelect.disabled = false;
        
        // 获取当前用户有权限的节点（只能在自己管理的节点下创建子节点）
        const accessibleNodes = getAccessibleNodes();
        const currentUser = getCurrentUser();
        
        // 如果是超级管理员，可以创建根节点；否则只能在自己管理的节点下创建
        if (currentUser && currentUser.role === "超级管理员") {
          // 超级管理员可以看到所有节点
          const allNodes = mockData.organizations || mockData.enterprises;
          allNodes.forEach(node => {
            const option = document.createElement('option');
            option.value = node.id;
            option.textContent = `${node.type || '企业'} - ${node.name}`;
            parentSelect.appendChild(option);
          });
        } else {
          // 子层级管理员只能在自己管理的节点下创建子节点
          accessibleNodes.forEach(node => {
            const option = document.createElement('option');
            option.value = node.id;
            option.textContent = `${node.type || '企业'} - ${node.name}`;
            parentSelect.appendChild(option);
          });
          
          // 如果不是超级管理员，默认选中第一个可访问的节点（如果有）
          if (accessibleNodes.length > 0) {
            parentSelect.value = accessibleNodes[0].id;
          }
        }
      }
      
      // 重置表单
      document.getElementById('new-ent-name').value = '';
      document.getElementById('new-ent-type').value = '部门'; // 默认改为部门
      document.getElementById('new-ent-admin-name').value = '';
      document.getElementById('new-ent-admin-phone').value = '';
      document.getElementById('new-quota-base').value = '20';
      document.getElementById('new-quota-premium').value = '5';
      
      // 更新弹窗标题
      const modalTitle = document.getElementById('modal-title');
      if (parentId) {
        modalTitle.textContent = '新增子节点';
      } else {
        modalTitle.textContent = '新增组织节点';
      }
      
      document.getElementById('add-enterprise-modal').classList.remove('hidden');
      calculateResources(); // 初始化计算
    }

    function closeAddEnterpriseModal() {
      // 重置父节点下拉框状态
      const parentSelect = document.getElementById('new-ent-parent');
      parentSelect.disabled = false;
      
      document.getElementById('add-enterprise-modal').classList.add('hidden');
    }

    function calculateResources() {
      const baseCount = parseInt(document.getElementById('new-quota-base').value) || 0;
      const premiumCount = parseInt(document.getElementById('new-quota-premium').value) || 0;

      const totalStorage = (baseCount * RESOURCE_RULES.base.storage) + (premiumCount * RESOURCE_RULES.premium.storage);
      const totalAi = (baseCount * RESOURCE_RULES.base.ai) + (premiumCount * RESOURCE_RULES.premium.ai);
      const totalLive = (baseCount * RESOURCE_RULES.base.live) + (premiumCount * RESOURCE_RULES.premium.live);

      document.getElementById('calc-storage').textContent = `${totalStorage} GB`;
      document.getElementById('calc-ai').textContent = totalAi.toLocaleString();
      document.getElementById('calc-live').textContent = `${totalLive} 分钟`;

      return { totalStorage, totalAi, totalLive };
    }

    function saveNewEnterprise() {
       const name = document.getElementById('new-ent-name').value;
       const type = document.getElementById('new-ent-type').value;
       const parentIdValue = document.getElementById('new-ent-parent').value;
       const parentId = parentIdValue ? parseInt(parentIdValue) : null;
       const adminName = document.getElementById('new-ent-admin-name').value;
       const adminPhone = document.getElementById('new-ent-admin-phone').value;
       
       // 权限检查：如果不是超级管理员，只能在自己管理的节点下创建子节点
       if (parentId) {
         if (!isNodeAccessible(parentId)) {
           alert('您没有权限在此节点下创建子节点');
           return;
         }
       } else {
         // 创建根节点需要超级管理员权限
         const currentUser = getCurrentUser();
         if (!currentUser || currentUser.role !== "超级管理员") {
           alert('只有超级管理员可以创建根节点');
           return;
         }
       }

       // Quota values from inputs
       const qBaseValue = document.getElementById('new-quota-base').value;
       const qPremiumValue = document.getElementById('new-quota-premium').value;
       const qBase = parseInt(qBaseValue);
       const qPremium = parseInt(qPremiumValue);
       
       // Calculate derived resources
       const { totalStorage, totalAi, totalLive } = calculateResources();

       if (!name || !type || !adminName || !adminPhone) {
         alert('请填写完整信息');
         return;
       }
       
       if (qBaseValue === '' || isNaN(qBase) || qBase < 0) {
         alert('请输入有效的基础版账号数量');
         return;
       }
       
       if (qPremiumValue === '' || isNaN(qPremium) || qPremium < 0) {
         alert('请输入有效的旗舰版账号数量');
         return;
       }
       
       if (!/^1[3-9]\d{9}$/.test(adminPhone)) {
         alert('请输入有效的手机号');
         return;
       }

       // 创建新节点
       const newNodeId = Date.now();
       const newEnt = {
         id: newNodeId,
         name: name,
         type: type,
         parentId: parentId,
         adminId: null, // 将在创建用户后设置
         description: `新创建的${type}`,
         contactInfo: `联系人：${adminName}，电话：${adminPhone}`,
         createdAt: new Date().toISOString().split('T')[0],
         projects: [],
         quota: {
            storage: { total: totalStorage, used: 0, unit: "GB" },
            baseLicense: { total: qBase, used: 0 },
            premiumLicense: { total: qPremium, used: 0 },
            aiTokens: { total: totalAi, used: 0 },
            liveStream: { total: totalLive, used: 0, unit: "分钟" }
         }
       };

       // 添加到organizations数组
       const orgs = mockData.organizations || mockData.enterprises;
       orgs.push(newEnt);
       
       // 创建管理员用户
       const adminUserId = Date.now() + 1;
       if (mockData.users) {
          mockData.users.push({
             id: adminUserId,
             username: adminPhone,
             fullName: adminName,
             phone: adminPhone,
             role: "企业平台主管",
             enterprise: name,
             organizationId: newNodeId, // 关联到组织节点
             project: "-",
             status: "激活",
             createdAt: new Date().toISOString().split('T')[0]
          });
       }
       
       // 设置节点的管理员ID
       newEnt.adminId = adminUserId;

       renderEnterpriseTree();
       selectEnterprise(newEnt.id);
       closeAddEnterpriseModal();
    }

    // 编辑组织相关函数
    window.openEditEnterpriseModal = function() {
      if (!currentEnterpriseId) {
        alert('请先选择组织');
        return;
      }
      
      const orgs = mockData.organizations || mockData.enterprises;
      const ent = orgs.find(e => e.id === currentEnterpriseId);
      if (!ent) return;

      // 填充表单数据
      document.getElementById('edit-ent-name').value = ent.name;
      document.getElementById('edit-quota-base').value = ent.quota?.baseLicense?.total || 0;
      document.getElementById('edit-quota-premium').value = ent.quota?.premiumLicense?.total || 0;
      
      // 解析管理员信息
      const contactInfo = ent.contactInfo || '';
      const adminMatch = contactInfo.match(/联系人：(.+?)，电话：(.+)/);
      const adminName = adminMatch ? adminMatch[1] : '';
      const adminPhone = adminMatch ? adminMatch[2] : '';
      
      document.getElementById('edit-ent-admin-name').value = adminName;
      document.getElementById('edit-ent-admin-phone').value = adminPhone;
      
      // 计算并显示资源
      calculateEditResources();
      
      document.getElementById('edit-enterprise-modal').classList.remove('hidden');
    }

    window.closeEditEnterpriseModal = function() {
      document.getElementById('edit-enterprise-modal').classList.add('hidden');
    }

    window.calculateEditResources = function() {
      const baseCount = parseInt(document.getElementById('edit-quota-base').value) || 0;
      const premiumCount = parseInt(document.getElementById('edit-quota-premium').value) || 0;

      const totalStorage = (baseCount * RESOURCE_RULES.base.storage) + (premiumCount * RESOURCE_RULES.premium.storage);
      const totalAi = (baseCount * RESOURCE_RULES.base.ai) + (premiumCount * RESOURCE_RULES.premium.ai);
      const totalLive = (baseCount * RESOURCE_RULES.base.live) + (premiumCount * RESOURCE_RULES.premium.live);

      document.getElementById('edit-calc-storage').textContent = `${totalStorage} GB`;
      document.getElementById('edit-calc-ai').textContent = totalAi.toLocaleString();
      document.getElementById('edit-calc-live').textContent = `${totalLive} 分钟`;

      return { totalStorage, totalAi, totalLive };
    }

    window.saveEditEnterprise = function() {
      if (!currentEnterpriseId) return;
      
      const orgs = mockData.organizations || mockData.enterprises;
      const ent = orgs.find(e => e.id === currentEnterpriseId);
      if (!ent) return;

      const name = document.getElementById('edit-ent-name').value;
      const adminName = document.getElementById('edit-ent-admin-name').value;
      const adminPhone = document.getElementById('edit-ent-admin-phone').value;
      const qBaseValue = document.getElementById('edit-quota-base').value;
      const qPremiumValue = document.getElementById('edit-quota-premium').value;
      const qBase = parseInt(qBaseValue);
      const qPremium = parseInt(qPremiumValue);
      
      const { totalStorage, totalAi, totalLive } = calculateEditResources();

      // 验证
      if (!name || !adminName || !adminPhone) {
        alert('请填写完整信息');
        return;
      }
      
      if (qBaseValue === '' || isNaN(qBase) || qBase < 0) {
        alert('请输入有效的基础版账号数量');
        return;
      }
      
      if (qPremiumValue === '' || isNaN(qPremium) || qPremium < 0) {
        alert('请输入有效的旗舰版账号数量');
        return;
      }
      
      if (!/^1[3-9]\d{9}$/.test(adminPhone)) {
        alert('请输入有效的手机号');
        return;
      }

      // 检查配额是否足够（新配额不能小于已使用量）
      const currentUsed = {
        storage: ent.quota?.storage?.used || 0,
        baseLicense: ent.quota?.baseLicense?.used || 0,
        premiumLicense: ent.quota?.premiumLicense?.used || 0,
        aiTokens: ent.quota?.aiTokens?.used || 0,
        liveStream: ent.quota?.liveStream?.used || 0
      };

      if (totalStorage < currentUsed.storage) {
        alert(`存储空间配额不能小于已使用量 (${currentUsed.storage} GB)`);
        return;
      }
      if (qBase < currentUsed.baseLicense) {
        alert(`基础版账号数量不能小于已使用量 (${currentUsed.baseLicense})`);
        return;
      }
      if (qPremium < currentUsed.premiumLicense) {
        alert(`旗舰版账号数量不能小于已使用量 (${currentUsed.premiumLicense})`);
        return;
      }
      if (totalAi < currentUsed.aiTokens) {
        alert(`AI Tokens配额不能小于已使用量 (${currentUsed.aiTokens})`);
        return;
      }
      if (totalLive < currentUsed.liveStream) {
        alert(`直播时长配额不能小于已使用量 (${currentUsed.liveStream} 分钟)`);
        return;
      }

      // 更新企业信息
      ent.name = name;
      ent.contactInfo = `联系人：${adminName}，电话：${adminPhone}`;
      
      // 更新配额（保留已使用量）
      ent.quota = {
        storage: { total: totalStorage, used: currentUsed.storage, unit: "GB" },
        baseLicense: { total: qBase, used: currentUsed.baseLicense },
        premiumLicense: { total: qPremium, used: currentUsed.premiumLicense },
        aiTokens: { total: totalAi, used: currentUsed.aiTokens },
        liveStream: { total: totalLive, used: currentUsed.liveStream, unit: "分钟" }
      };

      // 更新管理员用户信息
      if (mockData.users) {
        const adminUser = mockData.users.find(u => (u.organizationId === ent.id || u.enterprise === ent.name) && (u.role === "企业平台主管" || u.role === "组织管理员" || u.role === "企业管理员" || u.role === "企业平台主管"));
        if (adminUser) {
          adminUser.fullName = adminName;
          adminUser.phone = adminPhone;
          adminUser.username = adminPhone;
          adminUser.enterprise = name; // 如果组织名称改变，同步更新
        }
      }

      // 如果组织名称改变，需要更新所有相关用户的enterprise字段
      if (name !== ent.name) {
        if (mockData.users) {
          mockData.users.forEach(u => {
            if (u.enterprise === ent.name) {
              u.enterprise = name;
            }
          });
        }
      }

      // 刷新视图
      renderEnterpriseTree();
      selectEnterprise(currentEnterpriseId);
      closeEditEnterpriseModal();
    }

    // 更多操作菜单
    window.toggleMoreActionsMenu = function() {
      const menu = document.getElementById('more-actions-menu');
      if (menu) {
        menu.classList.toggle('hidden');
      }
      
      // 点击外部关闭菜单
      document.addEventListener('click', function closeMenuOnOutsideClick(e) {
        if (!e.target.closest('#more-actions-menu') && !e.target.closest('button[onclick="toggleMoreActionsMenu()"]')) {
          menu.classList.add('hidden');
          document.removeEventListener('click', closeMenuOnOutsideClick);
        }
      });
    }

    window.exportEnterpriseData = function() {
      if (!currentEnterpriseId) {
        alert('请先选择组织');
        return;
      }
      
      const orgs = mockData.organizations || mockData.enterprises;
      const ent = orgs.find(e => e.id === currentEnterpriseId);
      if (!ent) return;

      // 构建导出数据
      const exportData = {
        组织名称: ent.name,
        管理员: ent.contactInfo,
        注册时间: ent.createdAt,
        项目数量: ent.projects.length,
        资源配额: {
          存储空间: `${ent.quota?.storage?.used || 0}/${ent.quota?.storage?.total || 0} GB`,
          基础版账号: `${ent.quota?.baseLicense?.used || 0}/${ent.quota?.baseLicense?.total || 0}`,
          旗舰版账号: `${ent.quota?.premiumLicense?.used || 0}/${ent.quota?.premiumLicense?.total || 0}`,
          AI使用量: `${ent.quota?.aiTokens?.used || 0}/${ent.quota?.aiTokens?.total || 0}`,
          视频直播: `${ent.quota?.liveStream?.used || 0}/${ent.quota?.liveStream?.total || 0} 分钟`
        },
        项目列表: ent.projects.map(p => ({
          项目名称: p.name,
          负责人: p.projectAdmin,
          状态: p.status
        }))
      };

      // 转换为JSON并下载
      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${ent.name}_数据导出_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
      
      // 关闭菜单
      document.getElementById('more-actions-menu').classList.add('hidden');
    }

    window.openDeleteEnterpriseModal = function() {
      if (!currentEnterpriseId) {
        alert('请先选择组织');
        return;
      }
      
      const orgs = mockData.organizations || mockData.enterprises;
      const ent = orgs.find(e => e.id === currentEnterpriseId);
      if (!ent) return;

      document.getElementById('delete-enterprise-name').textContent = ent.name;
      document.getElementById('delete-enterprise-modal').classList.remove('hidden');
      
      // 关闭更多操作菜单
      document.getElementById('more-actions-menu').classList.add('hidden');
    }

    window.closeDeleteEnterpriseModal = function() {
      document.getElementById('delete-enterprise-modal').classList.add('hidden');
    }

    window.confirmDeleteEnterprise = function() {
      if (!currentEnterpriseId) return;
      
      const orgs = mockData.organizations || mockData.enterprises;
      const ent = orgs.find(e => e.id === currentEnterpriseId);
      if (!ent) return;

      // 获取所有子节点
      const allDescendantIds = getAllDescendantIds(currentEnterpriseId);
      const allRelatedNodes = orgs.filter(org => allDescendantIds.includes(org.id));
      
      // 统计所有相关节点的项目数
      let totalProjects = 0;
      allRelatedNodes.forEach(node => {
        if (node.projects) {
          totalProjects += node.projects.length;
        }
      });

      // 检查是否有项目
      if (totalProjects > 0) {
        if (!confirm(`该节点及其所有子节点下共有 ${totalProjects} 个项目，确定要删除吗？删除后将同时删除所有子节点。`)) {
          return;
        }
      } else {
        if (!confirm(`确定要删除节点 "${ent.name}" 吗？删除后将同时删除所有子节点。`)) {
          return;
        }
      }

      // 删除节点及其所有子节点
      const nodesToDelete = allDescendantIds;
      nodesToDelete.forEach(nodeId => {
        const index = orgs.findIndex(e => e.id === nodeId);
        if (index > -1) {
          orgs.splice(index, 1);
        }
      });

      // 删除相关用户（通过organizationId或enterprise名称匹配）
      if (mockData.users) {
        allRelatedNodes.forEach(node => {
          mockData.users = mockData.users.filter(u => 
            u.organizationId !== node.id && u.enterprise !== node.name
          );
        });
      }

      // 重置当前选择
      currentEnterpriseId = null;
      
      // 刷新视图
      renderEnterpriseTree();
      
      // 清空详情显示
      document.getElementById('detail-name').textContent = '选择组织';
      document.getElementById('detail-contact').textContent = '-';
      document.getElementById('detail-date').textContent = '-';
      document.getElementById('detail-projects-count').textContent = '0';
      
      // 清空各个tab的内容
      document.getElementById('project-list-body').innerHTML = '';
      document.getElementById('device-list-body').innerHTML = '';
      document.getElementById('member-list-body').innerHTML = '';
      
      // 关闭模态框
      closeDeleteEnterpriseModal();
      
      // 如果还有组织节点，选中第一个可访问的
      if (orgs.length > 0) {
        const accessibleIds = getAccessibleNodeIds();
        if (accessibleIds === null) {
          // 超级管理员，选中第一个
          selectEnterprise(orgs[0].id);
        } else if (accessibleIds.length > 0) {
          // 子层级管理员，选中第一个可访问的
          selectEnterprise(accessibleIds[0]);
        }
      }
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      // 渲染布局
      renderLayout('企业管理');

      renderEnterpriseTree();
      // 默认选中第一个可访问的节点
      const orgs = mockData.organizations || mockData.enterprises;
      if (orgs.length > 0) {
        const accessibleIds = getAccessibleNodeIds();
        if (accessibleIds === null) {
          // 超级管理员，选中第一个根节点
          const rootNodes = orgs.filter(org => !org.parentId);
          if (rootNodes.length > 0) {
            selectEnterprise(rootNodes[0].id);
          }
        } else if (accessibleIds.length > 0) {
          // 子层级管理员，选中第一个可访问的
          selectEnterprise(accessibleIds[0]);
        }
      }
    });

    let currentEnterpriseId = null;
    let chartInstance = null;
    let currentEnterpriseProjects = []; // 存储当前企业的所有项目，用于筛选
    let currentEnterpriseDevices = []; // 存储当前企业的所有设备，用于筛选
    let currentEnterpriseMembers = []; // 存储当前企业的所有成员，用于筛选
    let filteredMemberList = []; // 存储当前显示的成员列表（用于编辑/删除时通过索引查找）
    let editingMemberIndex = -1; // 当前编辑的成员索引，-1表示新增
    
    // 获取当前登录用户（模拟，实际应该从session或token获取）
    function getCurrentUser() {
      // 模拟当前用户是超级管理员，可以看到所有节点
      // 如果是子层级管理员，应该返回对应的用户信息
      return mockData.users.find(u => u.role === "超级管理员") || mockData.users[0];
    }
    
    // 获取用户有权限查看的节点ID列表
    function getAccessibleNodeIds() {
      const currentUser = getCurrentUser();
      if (!currentUser) return null; // 无用户，返回null表示无权限
      
      // 超级管理员可以看到所有节点
      if (currentUser.role === "超级管理员") {
        return null; // null表示所有节点
      }
      
      // 查找用户管理的组织节点
      const orgs = mockData.organizations || mockData.enterprises;
      const managedNode = orgs.find(org => org.adminId === currentUser.id);
      
      if (!managedNode) {
        // 如果没有找到管理的节点，可能是通过enterprise字段关联的（向后兼容）
        const nodeByName = orgs.find(org => org.name === currentUser.enterprise);
        if (nodeByName) {
          // 返回该节点及其所有子节点
          return getAllDescendantIds(nodeByName.id);
        }
        return []; // 无权限
      }
      
      // 返回该节点及其所有子节点
      return getAllDescendantIds(managedNode.id);
    }
    
    // 检查节点是否在可访问列表中
    function isNodeAccessible(nodeId) {
      const accessibleIds = getAccessibleNodeIds();
      if (accessibleIds === null) return true; // null表示所有节点都可访问
      return accessibleIds.includes(nodeId);
    }
    
    // 获取可访问的节点列表（用于创建子节点时的父节点选择）
    function getAccessibleNodes() {
      const orgs = mockData.organizations || mockData.enterprises;
      const accessibleIds = getAccessibleNodeIds();
      
      if (accessibleIds === null) {
        return orgs; // 所有节点
      }
      
      return orgs.filter(org => accessibleIds.includes(org.id));
    }

    // 存储展开的节点ID
    let expandedNodes = new Set();
    
    // 获取节点的所有子节点
    function getChildrenNodes(parentId) {
      const orgs = mockData.organizations || mockData.enterprises;
      return orgs.filter(org => org.parentId === parentId);
    }
    
    // 获取节点的所有后代节点ID（用于权限过滤）
    function getAllDescendantIds(nodeId) {
      const result = [nodeId];
      const children = getChildrenNodes(nodeId);
      children.forEach(child => {
        result.push(...getAllDescendantIds(child.id));
      });
      return result;
    }
    
    // 渲染单个树节点
    function renderTreeNode(node, level = 0, parentExpanded = true) {
      const children = getChildrenNodes(node.id);
      const hasChildren = children.length > 0;
      const isExpanded = expandedNodes.has(node.id);
      const isSelected = currentEnterpriseId === node.id;
      
      const item = document.createElement('div');
      item.className = `tree-node ${!parentExpanded ? 'hidden' : ''}`;
      item.setAttribute('data-node-id', node.id);
      
      const indent = level * 20; // 每级缩进20px
      
      item.innerHTML = `
        <div class="flex items-center justify-between p-2 rounded-lg mb-1 transition-colors hover:bg-gray-50 ${isSelected ? 'bg-blue-50 border-l-4 border-blue-500' : ''}" style="padding-left: ${indent + 8}px;">
          <div class="flex items-center space-x-2 flex-1" onclick="selectEnterprise(${node.id})">
            ${hasChildren ? `
              <button onclick="event.stopPropagation(); toggleNode(${node.id})" class="flex-shrink-0 w-5 h-5 flex items-center justify-center text-gray-400 hover:text-gray-600">
                <svg class="w-4 h-4 transform transition-transform ${isExpanded ? 'rotate-90' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            ` : '<div class="w-5"></div>'}
            <div class="flex-shrink-0">
              <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-blue-100 text-blue-600 font-semibold text-sm">
                ${node.name.substring(0, 1)}
              </span>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center space-x-2">
                <p class="text-sm font-medium text-gray-900 truncate">${node.name}</p>
                <span class="text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-600">${node.type || '企业'}</span>
              </div>
              <p class="text-xs text-gray-500">${node.projects ? node.projects.length : 0} 个项目</p>
            </div>
          </div>
          <div class="flex items-center space-x-1" onclick="event.stopPropagation()">
            <button onclick="openAddEnterpriseModal(${node.id})" class="p-1 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded" title="添加子节点">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
            </button>
          </div>
        </div>
      `;
      
      return item;
    }
    
    // 切换节点展开/折叠
    window.toggleNode = function(nodeId) {
      if (expandedNodes.has(nodeId)) {
        expandedNodes.delete(nodeId);
      } else {
        expandedNodes.add(nodeId);
      }
      renderEnterpriseTree();
    }
    
    // 渲染整个树
    function renderEnterpriseTree() {
      const treeContainer = document.getElementById('enterprise-tree');
      treeContainer.innerHTML = '';
      
      const orgs = mockData.organizations || mockData.enterprises;
      const accessibleIds = getAccessibleNodeIds();
      
      // 获取根节点（parentId为null的节点），并根据权限过滤
      let rootNodes = orgs.filter(org => !org.parentId);
      
      // 如果不是超级管理员，只显示有权限的根节点
      if (accessibleIds !== null) {
        rootNodes = rootNodes.filter(org => accessibleIds.includes(org.id));
      }
      
      // 递归渲染树
      function renderNodeRecursive(node, level = 0, parentExpanded = true) {
        // 检查权限
        if (!isNodeAccessible(node.id)) {
          return;
        }
        
        const nodeElement = renderTreeNode(node, level, parentExpanded);
        treeContainer.appendChild(nodeElement);
        
        const children = getChildrenNodes(node.id);
        const isExpanded = expandedNodes.has(node.id);
        
        if (children.length > 0 && isExpanded) {
          children.forEach(child => {
            renderNodeRecursive(child, level + 1, true);
          });
        }
      }
      
      rootNodes.forEach(root => {
        renderNodeRecursive(root, 0, true);
      });
      
      // 如果没有根节点，显示提示
      if (rootNodes.length === 0) {
        const currentUser = getCurrentUser();
        if (currentUser && currentUser.role !== "超级管理员") {
          treeContainer.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">您没有管理任何组织节点</div>';
        } else {
          treeContainer.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">暂无组织节点，请创建根节点</div>';
        }
      }
    }

    function selectEnterprise(id) {
      // 权限检查
      if (!isNodeAccessible(id)) {
        alert('您没有权限查看此节点');
        return;
      }
      
      currentEnterpriseId = id;
      const orgs = mockData.organizations || mockData.enterprises;
      const ent = orgs.find(e => e.id === id);
      if (!ent) return;

      // 获取当前节点及其所有子节点的ID
      const nodeIds = getAllDescendantIds(id);
      
      // 聚合所有相关节点的数据
      const relatedNodes = orgs.filter(org => nodeIds.includes(org.id));

      // 更新树的高亮状态
      renderEnterpriseTree();

      // 更新详情 (概览 Tab)
      document.getElementById('detail-name').textContent = ent.name;
      const contactText = ent.contactInfo ? ent.contactInfo.split('，')[0].replace('联系人：', '') : '-';
      document.getElementById('detail-contact').textContent = contactText;
      document.getElementById('detail-date').textContent = ent.createdAt || '-';
      
      // 聚合所有子节点的项目
      let allProjects = [];
      relatedNodes.forEach(node => {
        if (node.projects && node.projects.length > 0) {
          allProjects = allProjects.concat(node.projects);
        }
      });
      document.getElementById('detail-projects-count').textContent = allProjects.length;

      // 聚合配额数据（当前节点及其所有子节点）
      const aggregatedQuota = {
        storage: { total: 0, used: 0, unit: "GB" },
        baseLicense: { total: 0, used: 0 },
        premiumLicense: { total: 0, used: 0 },
        aiTokens: { total: 0, used: 0 },
        liveStream: { total: 0, used: 0, unit: "分钟" }
      };
      
      relatedNodes.forEach(node => {
        if (node.quota) {
          aggregatedQuota.storage.total += node.quota.storage?.total || 0;
          aggregatedQuota.storage.used += node.quota.storage?.used || 0;
          aggregatedQuota.baseLicense.total += node.quota.baseLicense?.total || 0;
          aggregatedQuota.baseLicense.used += node.quota.baseLicense?.used || 0;
          aggregatedQuota.premiumLicense.total += node.quota.premiumLicense?.total || 0;
          aggregatedQuota.premiumLicense.used += node.quota.premiumLicense?.used || 0;
          aggregatedQuota.aiTokens.total += node.quota.aiTokens?.total || 0;
          aggregatedQuota.aiTokens.used += node.quota.aiTokens?.used || 0;
          aggregatedQuota.liveStream.total += node.quota.liveStream?.total || 0;
          aggregatedQuota.liveStream.used += node.quota.liveStream?.used || 0;
        }
      });

      // 渲染资源卡片（使用聚合后的配额）
      renderResourceGrid(aggregatedQuota);

      // 更新图表 (概览 Tab) - 使用聚合后的配额
      updateChart({ ...ent, quota: aggregatedQuota });

      // 保存当前节点及其所有子节点的项目
      currentEnterpriseProjects = allProjects;
      // 渲染项目列表
      renderProjectList(currentEnterpriseProjects);

      // 收集所有设备数据（从所有相关节点的项目中）
      currentEnterpriseDevices = [];
      allProjects.forEach(proj => {
        if(proj.devices && proj.devices.length > 0) {
          proj.devices.forEach(dev => {
            currentEnterpriseDevices.push({
              ...dev,
              projectName: proj.name
            });
          });
        }
      });
      renderDeviceList(currentEnterpriseDevices);

      // 收集成员数据（当前节点及其所有子节点的成员）
      currentEnterpriseMembers = [];
      
      // 从 mockData.users 筛选相关节点的成员
      if (typeof mockData.users !== 'undefined') {
        relatedNodes.forEach(node => {
          // 通过organizationId或enterprise名称匹配
          const nodeUsers = mockData.users.filter(u => 
            u.organizationId === node.id || u.enterprise === node.name
          );
          nodeUsers.forEach(u => {
            currentEnterpriseMembers.push({
              phone: u.phone,
              name: u.fullName,
              role: u.role,
              org: node.name,
              memberType: '组织成员'
            });
          });
        });
      }

      renderMemberList(currentEnterpriseMembers);
    }

    function renderDeviceList(devices) {
      const deviceBody = document.getElementById('device-list-body');
      deviceBody.innerHTML = '';

      if (devices.length === 0) {
        deviceBody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-gray-500 text-sm">暂无设备</td></tr>';
        return;
      }

      devices.forEach(dev => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${dev.name}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${dev.type}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${dev.projectName}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${dev.location}</td>
          <td class="px-4 py-3 whitespace-nowrap text-right">
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${dev.status === 'online' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
              ${dev.status === 'online' ? '在线' : '离线'}
            </span>
          </td>
        `;
        deviceBody.appendChild(tr);
      });
    }

    function filterDeviceList() {
      if (!currentEnterpriseDevices || currentEnterpriseDevices.length === 0) {
        renderDeviceList([]);
        return;
      }

      const nameFilter = document.getElementById('device-filter-name').value.toLowerCase();
      const typeFilter = document.getElementById('device-filter-type').value;
      const projectFilter = document.getElementById('device-filter-project').value.toLowerCase();
      const statusFilter = document.getElementById('device-filter-status').value;

      const filtered = currentEnterpriseDevices.filter(dev => {
        const matchName = !nameFilter || dev.name.toLowerCase().includes(nameFilter);
        const matchType = !typeFilter || dev.type === typeFilter;
        const matchProject = !projectFilter || dev.projectName.toLowerCase().includes(projectFilter);
        const matchStatus = !statusFilter || dev.status === statusFilter;

        return matchName && matchType && matchProject && matchStatus;
      });

      renderDeviceList(filtered);
    }

    function renderMemberList(members) {
      const memberBody = document.getElementById('member-list-body');
      memberBody.innerHTML = '';
      
      // 保存当前显示的成员列表，用于编辑/删除时通过索引查找
      filteredMemberList = members;

      if (members.length === 0) {
        memberBody.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-center text-gray-500 text-sm">暂无成员信息</td></tr>';
        return;
      }

      // 只显示组织成员
      members.forEach((member, index) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${member.phone || '-'}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${member.name}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${member.role}</td>
          <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="openEditMemberModal(${index})" class="text-blue-600 hover:text-blue-900 mr-3">编辑</button>
            <button onclick="deleteMember(${index})" class="text-red-600 hover:text-red-900">删除</button>
          </td>
        `;
        memberBody.appendChild(tr);
      });
    }

    function filterMemberList() {
      if (!currentEnterpriseMembers || currentEnterpriseMembers.length === 0) {
        renderMemberList([]);
        return;
      }

      const phoneFilter = document.getElementById('member-filter-phone').value;
      const nameFilter = document.getElementById('member-filter-name').value.toLowerCase();
      const roleFilter = document.getElementById('member-filter-role').value.toLowerCase();

      const filtered = currentEnterpriseMembers.filter(member => {
        const matchPhone = !phoneFilter || (member.phone && member.phone.includes(phoneFilter));
        const matchName = !nameFilter || member.name.toLowerCase().includes(nameFilter);
        const matchRole = !roleFilter || member.role.toLowerCase().includes(roleFilter);

        return matchPhone && matchName && matchRole;
      });

      renderMemberList(filtered);
    }

    // 成员管理相关函数
    function openAddMemberModal() {
      editingMemberIndex = -1;
      document.getElementById('member-modal-title').textContent = '新增成员';
      document.getElementById('member-phone').value = '';
      document.getElementById('member-name').value = '';
      document.getElementById('member-role').value = '';
      document.getElementById('member-phone').disabled = false;
      document.getElementById('member-modal').classList.remove('hidden');
    }

    function openEditMemberModal(index) {
      if (index < 0 || index >= filteredMemberList.length) return;
      
      editingMemberIndex = index;
      const member = filteredMemberList[index];
      
      document.getElementById('member-modal-title').textContent = '编辑成员';
      document.getElementById('member-phone').value = member.phone || '';
      document.getElementById('member-name').value = member.name || '';
      document.getElementById('member-role').value = member.role || '';
      document.getElementById('member-phone').disabled = true; // 编辑时不允许修改手机号
      document.getElementById('member-modal').classList.remove('hidden');
    }

    function closeMemberModal() {
      document.getElementById('member-modal').classList.add('hidden');
      editingMemberIndex = -1;
    }

    function saveMember() {
      const phone = document.getElementById('member-phone').value.trim();
      const name = document.getElementById('member-name').value.trim();
      const role = document.getElementById('member-role').value;

      if (!phone || !name || !role) {
        alert('请填写完整信息');
        return;
      }

      if (!/^1[3-9]\d{9}$/.test(phone)) {
        alert('请输入正确的11位手机号');
        return;
      }

      const orgs = mockData.organizations || mockData.enterprises;
      const ent = orgs.find(e => e.id === currentEnterpriseId);
      if (!ent) return;

      if (editingMemberIndex === -1) {
        // 新增成员
        // 检查手机号是否已存在
        const existingUser = mockData.users.find(u => u.phone === phone || u.username === phone);
        if (existingUser) {
          alert('该手机号已存在，请使用其他手机号');
          return;
        }

        // 创建新用户
        const newUser = {
          id: Date.now(),
          username: phone,
          fullName: name,
          phone: phone,
          role: role,
          enterprise: ent.name,
          project: '-',
          status: '激活',
          createdAt: new Date().toISOString().split('T')[0]
        };

        if (!mockData.users) {
          mockData.users = [];
        }
        mockData.users.push(newUser);

        // 添加到当前组织成员列表
        currentEnterpriseMembers.push({
          phone: phone,
          name: name,
          role: role,
            org: '组织直属',
            memberType: '组织成员'
        });

        alert('成员添加成功！');
      } else {
        // 编辑成员
        const member = filteredMemberList[editingMemberIndex];
        
        // 更新mockData.users中的用户信息
        const user = mockData.users.find(u => u.phone === member.phone || u.username === member.phone);
        if (user) {
          user.fullName = name;
          user.role = role;
        }

        // 更新currentEnterpriseMembers中的成员信息
        const memberIndex = currentEnterpriseMembers.findIndex(m => m.phone === member.phone);
        if (memberIndex !== -1) {
          currentEnterpriseMembers[memberIndex].name = name;
          currentEnterpriseMembers[memberIndex].role = role;
        }

        alert('成员信息更新成功！');
      }

      closeMemberModal();
      // 重新渲染列表（应用当前筛选条件）
      filterMemberList();
    }

    function deleteMember(index) {
      if (index < 0 || index >= filteredMemberList.length) return;

      const member = filteredMemberList[index];
      
      if (!confirm(`确定要删除成员 "${member.name}" (${member.phone}) 吗？`)) {
        return;
      }

      // 从mockData.users中删除
      if (mockData.users) {
        const userIndex = mockData.users.findIndex(u => u.phone === member.phone || u.username === member.phone);
        if (userIndex !== -1) {
          mockData.users.splice(userIndex, 1);
        }
      }

      // 从currentEnterpriseMembers中删除
      const memberIndex = currentEnterpriseMembers.findIndex(m => m.phone === member.phone);
      if (memberIndex !== -1) {
        currentEnterpriseMembers.splice(memberIndex, 1);
      }

      alert('成员删除成功！');
      // 重新渲染列表（应用当前筛选条件）
      filterMemberList();
    }

    // 新建项目相关函数（与project.html共享逻辑）
    function openCreateProjectModal() {
      // 填充组织节点下拉框，默认选择当前节点
      const entSelect = document.getElementById('new-project-enterprise');
      entSelect.innerHTML = '';
      const orgs = mockData.organizations || mockData.enterprises;
      // 只显示当前用户有权限的节点
      const accessibleNodes = getAccessibleNodes();
      accessibleNodes.forEach(ent => {
        const option = document.createElement('option');
        option.value = ent.id;
        option.textContent = ent.name;
        if (currentEnterpriseId && ent.id === currentEnterpriseId) {
          option.selected = true;
        }
        entSelect.appendChild(option);
      });
      
      // 重置表单
      document.getElementById('new-project-name').value = '';
      document.getElementById('new-project-version').value = 'base';
      document.getElementById('new-admin-name').value = '';
      document.getElementById('new-admin-phone').value = '';
      updateQuotaPreview();
      
      document.getElementById('create-project-modal').classList.remove('hidden');
    }

    function closeCreateProjectModal() {
      document.getElementById('create-project-modal').classList.add('hidden');
    }

    function updateQuotaPreview() {
      const version = document.getElementById('new-project-version').value;
      const preview = document.getElementById('quota-preview');
      if (version === 'base') {
        preview.textContent = '含: 1000GB存储, 10万AI Tokens';
      } else {
        preview.textContent = '含: 5000GB存储, 50万AI Tokens';
      }
    }

    function saveNewProjectFromEnterprise() {
      const name = document.getElementById('new-project-name').value;
      const entId = parseInt(document.getElementById('new-project-enterprise').value);
      const version = document.getElementById('new-project-version').value;
      const adminName = document.getElementById('new-admin-name').value;
      const adminPhone = document.getElementById('new-admin-phone').value;
      
      // Auto-assign quota based on version
      let storage, ai;
      let verName = "基础版";
      if (version === 'base') {
        storage = 1000;
        ai = 100000;
        verName = "基础版";
      } else {
        storage = 5000;
        ai = 500000;
        verName = "旗舰版";
      }

      if (!name || !adminName || !adminPhone || !version) {
        alert("请填写完整的项目信息和负责人信息");
        return;
      }
      
      if (version !== 'base' && version !== 'premium') {
        alert("请选择有效的项目版本");
        return;
      }
      
      if (!/^1[3-9]\d{9}$/.test(adminPhone)) {
        alert("请输入正确的11位手机号");
        return;
      }

      // 1. 创建项目对象
      const newProject = {
        id: Date.now(),
        name: name,
        version: verName,
        description: "新创建的项目",
        projectAdmin: adminName,
        allocatedQuota: storage * 2 + ai,
        storageUsed: 0,
        aiUsed: 0,
        status: "进行中",
        createdAt: new Date().toISOString().split('T')[0],
        quota: {
           storage: { total: storage, used: 0, unit: "GB" },
           aiTokens: { total: ai, used: 0 },
           baseLicense: { total: 10, used: 0 },
           premiumLicense: { total: 2, used: 0 },
           liveStream: { total: 100, used: 0, unit: "分钟" }
        },
        devices: [],
        teamMembers: [
          {
            id: Date.now() + 1,
            name: adminName,
            role: "项目平台主管",
            phone: adminPhone
          }
        ],
        subcontractors: []
      };

      // 2. 将项目添加到对应组织节点
      const orgs = mockData.organizations || mockData.enterprises;
      const enterprise = orgs.find(e => e.id === entId);
      if (enterprise) {
        enterprise.projects.push(newProject);
      }

      // 3. 处理用户逻辑 (检查是否已存在，不存在则新建)
      let existingUser = null;
      if (mockData.users) {
        existingUser = mockData.users.find(u => u.username === adminPhone);
      }
      
      if (!existingUser) {
        // 创建新用户
        const newUser = {
          id: Date.now() + 2,
          username: adminPhone,
          fullName: adminName,
          phone: adminPhone,
          role: "项目平台主管",
          enterprise: enterprise ? enterprise.name : "未知企业",
          project: name,
          status: "激活",
          createdAt: new Date().toISOString().split('T')[0]
        };
        if (mockData.users) {
          mockData.users.push(newUser);
        }
        alert(`项目 "${name}" 创建成功！\n已自动创建负责人账号：${adminPhone}\n初始密码：123456`);
      } else {
         alert(`项目 "${name}" 创建成功！\n负责人账号 ${adminPhone} 已存在，已自动赋予该项目管理权限。`);
      }

      closeCreateProjectModal();
      
      // 如果当前显示的就是该企业，刷新项目列表
      if (currentEnterpriseId === entId) {
        currentEnterpriseProjects = enterprise.projects || [];
        renderProjectList(currentEnterpriseProjects);
        // 更新项目总数
        document.getElementById('detail-projects-count').textContent = enterprise.projects.length;
      }
    }

    function switchTab(tabName) {
      // Hide all contents
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      // Show selected content
      document.getElementById(`content-${tabName}`).classList.remove('hidden');
      
      // Reset all buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
      });
      
      // Activate selected button
      const activeBtn = document.getElementById(`tab-${tabName}`);
      activeBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
      activeBtn.classList.add('border-blue-500', 'text-blue-600');
    }

    // 获取项目负责人的手机号（与project.html中的逻辑一致）
    function getProjectAdminPhone(proj) {
      // 1. 先从teamMembers中查找匹配的成员
      if (proj.teamMembers && proj.teamMembers.length > 0) {
        const adminMember = proj.teamMembers.find(m => m.name === proj.projectAdmin);
        if (adminMember && adminMember.phone) {
          return adminMember.phone;
        }
        // 如果没有找到匹配的，取第一个成员的手机号
        if (proj.teamMembers[0].phone) {
          return proj.teamMembers[0].phone;
        }
      }
      
      // 2. 从mockData.users中查找
      if (typeof mockData !== 'undefined' && mockData.users) {
        const user = mockData.users.find(u => u.fullName === proj.projectAdmin || u.phone === proj.projectAdmin);
        if (user && user.phone) {
          return user.phone;
        }
      }
      
      // 3. 生成示例手机号（基于项目负责人姓名，生成一个固定的示例号码）
      const phoneMap = {
        '李博迪': '13800138001',
        '陈明浩': '13800138002',
        '赵奔': '13800138003'
      };
      
      if (phoneMap[proj.projectAdmin]) {
        return phoneMap[proj.projectAdmin];
      }
      
      // 默认生成一个示例手机号
      return '13800000000';
    }

    function renderProjectList(projects) {
      const projectBody = document.getElementById('project-list-body');
      projectBody.innerHTML = '';
      
      if (projects.length === 0) {
        projectBody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-gray-500 text-sm">暂无项目</td></tr>';
        return;
      }
      
      projects.forEach(proj => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 transition-colors';
        
        // 获取负责人手机号
        const adminPhone = getProjectAdminPhone(proj);
        
        // 计算存储和AI配额
        let storageTotal, aiTotal;
        if (proj.quota && proj.quota.storage && proj.quota.aiTokens) {
          storageTotal = proj.quota.storage.total;
          aiTotal = proj.quota.aiTokens.total;
        } else {
          // 如果没有quota，根据版本估算
          const version = proj.version || '基础版';
          if (version === '旗舰版') {
            storageTotal = 5000;
            aiTotal = 500000;
          } else {
            storageTotal = 1000;
            aiTotal = 100000;
          }
        }

        tr.innerHTML = `
          <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
            <a href="project-detail.html?id=${proj.id}" class="text-blue-600 hover:text-blue-900 hover:underline">
              ${proj.name}
            </a>
          </td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${proj.version === '旗舰版' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">
              ${proj.version || '基础版'}
            </span>
          </td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${proj.projectAdmin}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${adminPhone}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
            ${proj.storageUsed || 0} / ${storageTotal} GB
          </td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
            ${proj.aiUsed || 0} / ${aiTotal}
          </td>
        `;
        projectBody.appendChild(tr);
      });
    }

    function filterProjectList() {
      if (!currentEnterpriseProjects || currentEnterpriseProjects.length === 0) {
        renderProjectList([]);
        return;
      }

      const nameFilter = document.getElementById('project-filter-name').value.toLowerCase();
      const versionFilter = document.getElementById('project-filter-version').value;
      const adminFilter = document.getElementById('project-filter-admin').value.toLowerCase();
      const phoneFilter = document.getElementById('project-filter-phone').value;

      const filtered = currentEnterpriseProjects.filter(proj => {
        const matchName = !nameFilter || proj.name.toLowerCase().includes(nameFilter);
        const matchVersion = !versionFilter || (proj.version || '基础版') === versionFilter;
        const matchAdmin = !adminFilter || proj.projectAdmin.toLowerCase().includes(adminFilter);
        const adminMember = proj.teamMembers ? proj.teamMembers.find(m => m.name === proj.projectAdmin) : null;
        const adminPhone = adminMember ? adminMember.phone : '';
        const matchPhone = !phoneFilter || adminPhone.includes(phoneFilter);

        return matchName && matchVersion && matchAdmin && matchPhone;
      });

      renderProjectList(filtered);
    }

    // 额度消费记录相关函数
    let quotaConsumptionData = []; // 存储消费记录数据
    let currentQuotaFilter = null; // 当前筛选的资源类型
    let filteredQuotaData = []; // 筛选后的数据
    let currentQuotaPage = 1; // 当前页码
    const quotaPageSize = 10; // 每页显示条数

    function openQuotaConsumptionModal(resourceType = null, resourceLabel = null) {
      currentQuotaFilter = resourceType;
      
      // 设置标题
      const titleEl = document.getElementById('quota-modal-title');
      if (resourceType && resourceLabel) {
        titleEl.textContent = `${resourceLabel} - 额度消费记录`;
      } else {
        titleEl.textContent = '额度消费记录';
      }

      // 设置筛选条件
      if (resourceType) {
        document.getElementById('quota-filter-type').value = resourceType;
      } else {
        document.getElementById('quota-filter-type').value = '';
      }

      // 生成模拟数据
      generateQuotaConsumptionData(resourceType);

      // 重置到第一页
      currentQuotaPage = 1;

      // 渲染表格（会自动应用筛选和分页）
      renderQuotaConsumption();

      // 显示模态框
      document.getElementById('quota-consumption-modal').classList.remove('hidden');
    }

    function closeQuotaConsumptionModal() {
      document.getElementById('quota-consumption-modal').classList.add('hidden');
      currentQuotaFilter = null;
    }

    function generateQuotaConsumptionData(resourceType = null) {
      quotaConsumptionData = [];
      const orgs = mockData.organizations || mockData.enterprises;
      const ent = orgs.find(e => e.id === currentEnterpriseId);
      if (!ent) return;

      // 资源类型映射
      const typeMap = {
        'storage': '存储空间',
        'aiTokens': 'AI 使用量',
        'liveStream': '视频直播',
        'baseLicense': '基础版账号',
        'premiumLicense': '旗舰版账号'
      };

      // 生成最近30天的消费记录
      const types = resourceType ? [resourceType] : Object.keys(typeMap);
      
      ent.projects.forEach(proj => {
        types.forEach(type => {
          // 每天生成1-3条记录
          for (let i = 0; i < 30; i++) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const recordCount = Math.floor(Math.random() * 3) + 1;
            
            for (let j = 0; j < recordCount; j++) {
              const consumption = Math.floor(Math.random() * 100) + 1;
              quotaConsumptionData.push({
                date: date.toISOString().split('T')[0],
                time: `${String(Math.floor(Math.random() * 24)).padStart(2, '0')}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}`,
                type: typeMap[type],
                projectName: proj.name,
                consumption: consumption,
                operation: Math.random() > 0.5 ? '消费' : '分配'
              });
            }
          }
        });
      });

      // 按日期倒序排列
      quotaConsumptionData.sort((a, b) => {
        const dateCompare = b.date.localeCompare(a.date);
        if (dateCompare !== 0) return dateCompare;
        return b.time.localeCompare(a.time);
      });
    }

    function renderQuotaConsumption() {
      // 先应用筛选
      filterQuotaConsumptionData();
      // 然后渲染当前页
      renderQuotaConsumptionPage();
    }

    function filterQuotaConsumptionData() {
      const typeFilterValue = document.getElementById('quota-filter-type').value;
      const projectFilter = document.getElementById('quota-filter-project').value.toLowerCase();
      const startDate = document.getElementById('quota-filter-start').value;
      const endDate = document.getElementById('quota-filter-end').value;

      // 类型映射
      const typeMap = {
        'storage': '存储空间',
        'aiTokens': 'AI 使用量',
        'liveStream': '视频直播',
        'baseLicense': '基础版账号',
        'premiumLicense': '旗舰版账号'
      };
      const typeFilterLabel = typeFilterValue ? typeMap[typeFilterValue] : null;

      filteredQuotaData = quotaConsumptionData.filter(record => {
        const matchType = !typeFilterLabel || record.type === typeFilterLabel;
        const matchProject = !projectFilter || record.projectName.toLowerCase().includes(projectFilter);
        const matchStart = !startDate || record.date >= startDate;
        const matchEnd = !endDate || record.date <= endDate;

        return matchType && matchProject && matchStart && matchEnd;
      });

      // 重置到第一页
      currentQuotaPage = 1;
    }

    function renderQuotaConsumptionPage() {
      const tbody = document.getElementById('quota-consumption-body');
      tbody.innerHTML = '';

      if (filteredQuotaData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-gray-500 text-sm">暂无消费记录</td></tr>';
        updateQuotaPaginationInfo(0);
        return;
      }

      // 计算分页
      const totalPages = Math.ceil(filteredQuotaData.length / quotaPageSize);
      const startIndex = (currentQuotaPage - 1) * quotaPageSize;
      const endIndex = Math.min(startIndex + quotaPageSize, filteredQuotaData.length);
      const pageData = filteredQuotaData.slice(startIndex, endIndex);

      pageData.forEach(record => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.date} ${record.time}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${record.type}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.projectName}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">${record.consumption.toLocaleString()}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm">
            <span class="px-2 py-0.5 rounded-full text-xs font-medium ${record.operation === '消费' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
              ${record.operation}
            </span>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // 更新分页信息
      updateQuotaPaginationInfo(filteredQuotaData.length, startIndex + 1, endIndex, totalPages);
    }

    function updateQuotaPaginationInfo(total, start = 0, end = 0, totalPages = 0) {
      document.getElementById('quota-total-count').textContent = total;
      document.getElementById('quota-page-start').textContent = start || 0;
      document.getElementById('quota-page-end').textContent = end || 0;

      // 更新页码按钮
      const pageNumbersEl = document.getElementById('quota-page-numbers');
      pageNumbersEl.innerHTML = '';

      if (totalPages <= 1) {
        // 只有一页或没有数据，不显示页码
        return;
      }

      // 显示页码（最多显示7个页码）
      let startPage = Math.max(1, currentQuotaPage - 3);
      let endPage = Math.min(totalPages, currentQuotaPage + 3);

      if (currentQuotaPage <= 4) {
        endPage = Math.min(7, totalPages);
      }
      if (currentQuotaPage >= totalPages - 3) {
        startPage = Math.max(1, totalPages - 6);
      }

      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.onclick = () => changeQuotaPage(i);
        pageBtn.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
          i === currentQuotaPage
            ? 'z-10 bg-blue-50 border-blue-500 text-blue-600'
            : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
        }`;
        pageBtn.textContent = i;
        pageNumbersEl.appendChild(pageBtn);
      }

      // 更新上一页/下一页按钮状态（桌面版和移动版）
      const prevBtn = document.getElementById('quota-prev-btn');
      const nextBtn = document.getElementById('quota-next-btn');
      const prevBtnMobile = document.getElementById('quota-prev-btn-mobile');
      const nextBtnMobile = document.getElementById('quota-next-btn-mobile');
      
      const buttons = [prevBtn, prevBtnMobile, nextBtn, nextBtnMobile];
      
      if (currentQuotaPage === 1) {
        if (prevBtn) {
          prevBtn.disabled = true;
          prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
        if (prevBtnMobile) {
          prevBtnMobile.disabled = true;
          prevBtnMobile.classList.add('opacity-50', 'cursor-not-allowed');
        }
      } else {
        if (prevBtn) {
          prevBtn.disabled = false;
          prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        if (prevBtnMobile) {
          prevBtnMobile.disabled = false;
          prevBtnMobile.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
      
      if (currentQuotaPage >= totalPages) {
        if (nextBtn) {
          nextBtn.disabled = true;
          nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
        if (nextBtnMobile) {
          nextBtnMobile.disabled = true;
          nextBtnMobile.classList.add('opacity-50', 'cursor-not-allowed');
        }
      } else {
        if (nextBtn) {
          nextBtn.disabled = false;
          nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        if (nextBtnMobile) {
          nextBtnMobile.disabled = false;
          nextBtnMobile.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
    }

    function changeQuotaPage(page) {
      const totalPages = Math.ceil(filteredQuotaData.length / quotaPageSize);
      if (page < 1 || page > totalPages) return;
      currentQuotaPage = page;
      renderQuotaConsumptionPage();
    }

    function filterQuotaConsumption() {
      // 重新筛选并渲染
      renderQuotaConsumption();
    }

    function renderResourceGrid(quota) {
      const grid = document.getElementById('resource-grid');
      grid.innerHTML = '';
      grid.className = 'flex flex-col gap-6'; // Change from grid to flex-col for sections

      if (!quota || Object.keys(quota).length === 0) {
        grid.innerHTML = '<p class="text-gray-500 text-sm">暂无配额数据</p>';
        return;
      }

      // Definition of sections
      const sections = [
        {
          title: '版本资源概览',
          items: [
            { key: 'baseLicense', label: '基础版账号', color: 'green' },
            { key: 'premiumLicense', label: '旗舰版账号', color: 'purple' }
          ]
        },
        {
          title: '基础资源概览',
          items: [
            { key: 'storage', label: '存储空间', color: 'blue' },
            { key: 'aiTokens', label: 'AI 使用量', color: 'indigo' },
            { key: 'liveStream', label: '视频直播', color: 'pink' }
          ]
        }
      ];

      sections.forEach(section => {
        const sectionDiv = document.createElement('div');
        sectionDiv.innerHTML = `<h4 class="text-sm font-semibold text-gray-700 mb-3">${section.title}</h4>`;
        
        const itemsGrid = document.createElement('div');
        itemsGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';

        let hasItems = false;
        section.items.forEach(res => {
          const data = quota[res.key];
          if (!data) return;
          hasItems = true;

          const percentage = data.total > 0 ? Math.round((data.used / data.total) * 100) : 0;
          const unit = data.unit || '';
          
          const card = document.createElement('div');
          card.className = "bg-gray-50 p-4 rounded-lg border border-gray-100 cursor-pointer hover:bg-gray-100 transition-colors";
          
          // 版本资源卡片：跳转到项目列表tab并筛选版本
          if (section.title === '版本资源概览') {
            const versionFilter = res.key === 'baseLicense' ? '基础版' : '旗舰版';
            card.onclick = () => {
              switchTab('projects');
              // 设置筛选条件
              setTimeout(() => {
                document.getElementById('project-filter-version').value = versionFilter;
                filterProjectList();
              }, 100); // 延迟确保tab已经切换
            };
          } else {
            // 基础资源卡片：弹出额度消费记录详情页
            card.onclick = () => {
              openQuotaConsumptionModal(res.key, res.label);
            };
          }
          
          card.innerHTML = `
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm font-medium text-gray-700">${res.label}</span>
              <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-${res.color}-100 text-${res.color}-800">
                ${percentage}%
              </span>
            </div>
            <div class="flex items-end space-x-1 mb-2">
              <span class="text-xl font-bold text-gray-900">${data.used.toLocaleString()}</span>
              <span class="text-sm text-gray-500 mb-1">/ ${data.total.toLocaleString()} ${unit}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-1.5">
              <div class="bg-${res.color}-500 h-1.5 rounded-full" style="width: ${percentage}%"></div>
            </div>
          `;
          itemsGrid.appendChild(card);
        });

        if (hasItems) {
          sectionDiv.appendChild(itemsGrid);
          grid.appendChild(sectionDiv);
        }
      });
    }

    function updateChart(ent) {
      const chartEl = document.getElementById('resourceChart');
      if (!chartEl) return;
      const ctx = chartEl.getContext('2d');
      
      if (chartInstance) {
        chartInstance.destroy();
      }

      // 获取当前使用量作为基准
      const storageUsed = ent.quota && ent.quota.storage ? ent.quota.storage.used : 1000;
      const aiUsed = ent.quota && ent.quota.aiTokens ? ent.quota.aiTokens.used : 500000;
      const liveUsed = ent.quota && ent.quota.liveStream ? ent.quota.liveStream.used : 1200;

      // 模拟近6个月的月度数据，基于当前使用量生成趋势
      const labels = ['1月', '2月', '3月', '4月', '5月', '6月'];
      
      // 存储空间趋势（蓝色）- 基于当前使用量生成变化趋势
      const dataStorage = [
        Math.round(storageUsed * 0.2),
        Math.round(storageUsed * 0.3),
        Math.round(storageUsed * 0.6),
        Math.round(storageUsed * 0.9),
        Math.round(storageUsed * 0.4),
        storageUsed
      ];
      
      // AI使用量趋势（紫色/indigo）- 基于当前使用量生成变化趋势
      const dataAI = [
        Math.round(aiUsed * 0.1),
        Math.round(aiUsed * 0.2),
        Math.round(aiUsed * 0.3),
        Math.round(aiUsed * 0.4),
        Math.round(aiUsed * 0.5),
        aiUsed
      ];
      
      // 视频直播趋势（粉色）- 基于当前使用量生成变化趋势
      const dataLive = [
        Math.round(liveUsed * 0.1),
        Math.round(liveUsed * 0.2),
        Math.round(liveUsed * 0.3),
        Math.round(liveUsed * 0.4),
        Math.round(liveUsed * 0.5),
        liveUsed
      ];

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: '存储空间',
              data: dataStorage,
              borderColor: 'rgb(59, 130, 246)', // blue-500
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'AI 使用量',
              data: dataAI,
              borderColor: 'rgb(99, 102, 241)', // indigo-500
              backgroundColor: 'rgba(99, 102, 241, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: '视频直播',
              data: dataLive,
              borderColor: 'rgb(236, 72, 153)', // pink-500
              backgroundColor: 'rgba(236, 72, 153, 0.1)',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }
  </script>
</body>
</html>
